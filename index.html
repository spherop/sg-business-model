<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Grid Business Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a24;
            --accent-cyan: #00f5d4;
            --accent-magenta: #f72585;
            --accent-yellow: #fee440;
            --accent-purple: #7b2cbf;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-muted: #4a4a5c;
            --border: #2a2a3a;
            --gradient-1: linear-gradient(135deg, #00f5d4 0%, #7b2cbf 100%);
            --gradient-2: linear-gradient(135deg, #f72585 0%, #fee440 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            z-index: 1000;
        }

        .container {
            max-width: 1680px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        header {
            text-align: center;
            margin-bottom: 48px;
            position: relative;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            letter-spacing: 4px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        h1 {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 800;
            line-height: 1.1;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Growth Settings Panel */
        .growth-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .curve-selector {
            display: flex;
            gap: 8px;
        }

        .curve-btn {
            padding: 10px 20px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .curve-btn:hover {
            border-color: var(--text-secondary);
        }

        .curve-btn.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .growth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }

        .year-card {
            background: var(--bg-input);
            border-radius: 16px;
            padding: 24px;
            position: relative;
        }

        .year-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 16px 16px 0 0;
        }

        .year-card.year-1::before { background: var(--accent-cyan); }
        .year-card.year-2::before { background: var(--accent-magenta); }
        .year-card.year-3::before { background: var(--accent-yellow); }

        .year-label {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .year-card.year-1 .year-label { color: var(--accent-cyan); }
        .year-card.year-2 .year-label { color: var(--accent-magenta); }
        .year-card.year-3 .year-label { color: var(--accent-yellow); }

        .year-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Space Mono', monospace;
        }

        .input-group input, .input-group select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.1);
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .chart-view-toggle {
            display: flex;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 4px;
        }

        .chart-view-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .chart-view-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .chart-view-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        .chart-legend {
            display: flex;
            gap: 24px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.artists { background: var(--accent-cyan); }
        .legend-dot.listeners { background: var(--accent-magenta); }
        .legend-dot.revenue { background: var(--accent-yellow); }

        .chart-area {
            height: 300px;
            position: relative;
            margin-bottom: 16px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .revenue-streams {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stream-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stream-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stream-card:hover::before,
        .stream-card.active::before {
            opacity: 1;
        }

        .stream-card.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 40px rgba(0, 245, 212, 0.1);
        }

        .stream-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stream-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stream-toggle {
            width: 52px;
            height: 28px;
            background: var(--bg-input);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid var(--border);
        }

        .stream-toggle.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .stream-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: var(--text-primary);
            border-radius: 50%;
            top: 2px;
            left: 3px;
            transition: transform 0.3s ease;
        }

        .stream-toggle.active::after {
            transform: translateX(24px);
        }

        .stream-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .stream-phase {
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-input);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stream-phase.mvp { background: rgba(0, 245, 212, 0.15); color: var(--accent-cyan); }
        .stream-phase.phase2 { background: rgba(247, 37, 133, 0.15); color: var(--accent-magenta); }
        .stream-phase.phase3 { background: rgba(254, 228, 64, 0.15); color: var(--accent-yellow); }

        .stream-revenues {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .stream-revenue-item {
            text-align: right;
        }

        .stream-revenue-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stream-revenue {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .stream-revenue.y1 { color: var(--accent-cyan); }
        .stream-revenue.y2 { color: var(--accent-magenta); }
        .stream-revenue.y3 { color: var(--accent-yellow); }

        .stream-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Summary Panel */
        .summary-panel {
            position: sticky;
            top: 24px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 245, 212, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .summary-title {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        .year-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .year-tab {
            flex: 1;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .year-tab:hover {
            border-color: var(--text-secondary);
        }

        .year-tab.active {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .total-revenue {
            margin-bottom: 32px;
        }

        .total-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .total-amount {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .total-period {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 14px;
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-value.positive { color: var(--accent-cyan); }
        .metric-value.highlight { color: var(--accent-magenta); }

        .three-year-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 12px;
        }

        .three-year-item {
            text-align: center;
        }

        .three-year-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .three-year-value {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }

        .three-year-item:nth-child(1) .three-year-value { color: var(--accent-cyan); }
        .three-year-item:nth-child(2) .three-year-value { color: var(--accent-magenta); }
        .three-year-item:nth-child(3) .three-year-value { color: var(--accent-yellow); }

        .breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .breakdown-amount {
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
        }

        /* Add Stream Button */
        .add-stream-btn {
            width: 100%;
            padding: 20px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 16px;
            color: var(--text-secondary);
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-stream-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 245, 212, 0.05);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .modal-inputs {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 32px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 245, 212, 0.3);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--text-secondary);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: var(--bg-input);
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Monthly Table */
        .monthly-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-top: 32px;
            overflow-x: auto;
        }

        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
        }

        .monthly-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border);
            color: var(--text-secondary);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .monthly-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .monthly-table tr:hover td {
            background: var(--bg-input);
        }

        .monthly-table .year-row {
            background: var(--bg-input);
        }

        .monthly-table .year-row td {
            font-weight: 700;
            border-bottom: 2px solid var(--border);
        }

        .table-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .table-toggle label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
        }

        .action-btn {
            padding: 10px 20px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .action-btn.export {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .action-btn.export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 245, 212, 0.3);
        }

        .action-btn.reset {
            color: var(--text-muted);
        }

        .action-btn.reset:hover {
            border-color: var(--accent-magenta);
            color: var(--accent-magenta);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 100px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            color: var(--accent-cyan);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        .save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .save-indicator svg {
            width: 14px;
            height: 14px;
        }

        /* Export loading state */
        .action-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .action-btn.loading::after {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 24px;
            background: var(--bg-input);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .view-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-tab:hover {
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        /* View Containers */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Business Plan View */
        .business-plan-view {
            padding-top: 32px;
        }

        .bp-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .bp-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bp-section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        /* Executive Summary */
        .executive-summary {
            text-align: center;
            margin-bottom: 32px;
        }

        .es-total-label {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .es-total-amount {
            font-family: 'Space Mono', monospace;
            font-size: 3.5rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .es-total-period {
            font-size: 14px;
            color: var(--text-muted);
        }

        .bp-metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 32px;
        }

        @media (max-width: 768px) {
            .bp-metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .bp-metric-box {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .bp-metric-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .bp-metric-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .bp-metric-value.y1 { color: var(--accent-cyan); }
        .bp-metric-value.y2 { color: var(--accent-magenta); }
        .bp-metric-value.y3 { color: var(--accent-yellow); }
        .bp-metric-value.streams { color: var(--text-primary); }

        /* Growth Assumptions */
        .bp-assumptions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .bp-assumptions {
                grid-template-columns: 1fr;
            }
        }

        .bp-assumption-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .bp-assumption-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .bp-assumption-card.y1::before { background: var(--accent-cyan); }
        .bp-assumption-card.y2::before { background: var(--accent-magenta); }
        .bp-assumption-card.y3::before { background: var(--accent-yellow); }

        .bp-assumption-title {
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .bp-assumption-card.y1 .bp-assumption-title { color: var(--accent-cyan); }
        .bp-assumption-card.y2 .bp-assumption-title { color: var(--accent-magenta); }
        .bp-assumption-card.y3 .bp-assumption-title { color: var(--accent-yellow); }

        .bp-assumption-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }

        .bp-assumption-row span:first-child {
            color: var(--text-secondary);
        }

        .bp-assumption-row span:last-child {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
        }

        .bp-curve-badge {
            display: inline-block;
            margin-top: 24px;
            padding: 8px 16px;
            background: var(--bg-input);
            border-radius: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bp-curve-badge span {
            color: var(--accent-cyan);
            text-transform: capitalize;
        }

        /* Business Plan Tables */
        .bp-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
        }

        .bp-table th {
            text-align: left;
            padding: 14px 16px;
            background: var(--bg-input);
            color: var(--text-secondary);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 11px;
            border-bottom: 2px solid var(--border);
        }

        .bp-table th:not(:first-child) {
            text-align: right;
        }

        .bp-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .bp-table td:not(:first-child) {
            text-align: right;
        }

        .bp-table tr:hover td {
            background: rgba(26, 26, 36, 0.5);
        }

        .bp-table .phase-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bp-table .phase-badge.mvp {
            background: rgba(0, 245, 212, 0.15);
            color: var(--accent-cyan);
        }
        .bp-table .phase-badge.phase2 {
            background: rgba(247, 37, 133, 0.15);
            color: var(--accent-magenta);
        }
        .bp-table .phase-badge.phase3 {
            background: rgba(254, 228, 64, 0.15);
            color: var(--accent-yellow);
        }

        .bp-table .total-row {
            background: var(--bg-input);
            font-weight: 700;
        }

        .bp-table .total-row td {
            border-bottom: none;
            padding: 16px;
        }

        .bp-table .year-header {
            background: var(--bg-input);
        }

        .bp-table .year-header td {
            font-weight: 700;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .bp-table .subtotal-row {
            background: rgba(26, 26, 36, 0.3);
        }

        .bp-table .subtotal-row td {
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        .bp-table .y1-value { color: var(--accent-cyan); }
        .bp-table .y2-value { color: var(--accent-magenta); }
        .bp-table .y3-value { color: var(--accent-yellow); }

        /* Start time selector */
        .start-time-group {
            display: flex;
            gap: 8px;
        }

        .start-time-group select {
            flex: 1;
            min-width: 0;
        }

        .stream-start-badge {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--bg-input);
            color: var(--text-muted);
            margin-left: 8px;
        }

        /* Fixed Reset Button */
        .reset-btn-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reset-btn-fixed:hover {
            border-color: var(--accent-magenta);
            color: var(--accent-magenta);
        }

        /* Business Plan Export Button */
        .bp-export-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 24px;
        }

        /* Larger fonts for Business Plan tables */
        .bp-table {
            font-size: 16px;
        }

        .bp-table th {
            font-size: 13px;
            padding: 18px 20px;
        }

        .bp-table td {
            padding: 16px 20px;
        }

        .bp-section-title {
            font-size: 1.5rem;
        }

        .es-total-label {
            font-size: 14px;
        }

        .es-total-amount {
            font-size: 4.5rem;
        }

        .es-total-period {
            font-size: 16px;
        }

        .bp-metric-label {
            font-size: 12px;
        }

        .bp-metric-value {
            font-size: 2rem;
        }

        .bp-assumption-title {
            font-size: 12px;
        }

        .bp-assumption-row {
            font-size: 15px;
            padding: 8px 0;
        }

        .bp-curve-badge {
            font-size: 14px;
        }

        /* Costs View Styles */
        .costs-view {
            padding-top: 32px;
        }

        .costs-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .costs-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .costs-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .action-btn.add-cost {
            background: var(--bg-card);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Syne', sans-serif;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .action-btn.add-cost:hover {
            background: rgba(0, 245, 212, 0.1);
        }

        .costs-totals-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }

        .cost-total-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .cost-total-card.grand {
            border-color: var(--accent-magenta);
            background: rgba(247, 37, 133, 0.05);
        }

        .cost-total-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .cost-total-amount {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-magenta);
        }

        .cost-total-card.grand .cost-total-amount {
            font-size: 1.8rem;
        }

        .cost-category {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .cost-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .cost-category-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cost-category-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cost-category-badge {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .cost-category-badge.infrastructure {
            background: rgba(0, 245, 212, 0.15);
            color: var(--accent-cyan);
        }

        .cost-category-badge.payroll {
            background: rgba(247, 37, 133, 0.15);
            color: var(--accent-magenta);
        }

        .cost-category-badge.opex {
            background: rgba(254, 228, 64, 0.15);
            color: var(--accent-yellow);
        }

        .cost-category-badge.marketing {
            background: rgba(123, 44, 191, 0.15);
            color: var(--accent-purple);
        }

        .cost-category-totals {
            display: flex;
            gap: 20px;
        }

        .cost-cat-year {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .cost-cat-label {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .cost-cat-amount {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cost-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .cost-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .cost-card:not(.inactive):hover {
            border-color: var(--accent-cyan);
        }

        .cost-card.inactive {
            opacity: 0.4;
        }

        .cost-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .cost-card-header .toggle {
            flex-shrink: 0;
        }

        .cost-name {
            flex: 1;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .cost-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .cost-delete:hover {
            color: #ff6b6b;
        }

        .cost-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .cost-year-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cost-year-input label {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .cost-year-input input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
            width: 100%;
        }

        .cost-year-input input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .cost-notes {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Cost Modal Styles */
        .modal-overlay#costModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay#costModalOverlay.active {
            display: flex;
        }

        .cost-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .cost-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .cost-modal .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .cost-modal .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .cost-modal .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-field {
            margin-bottom: 20px;
        }

        .modal-field label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .modal-field input,
        .modal-field select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
        }

        .modal-field input:focus,
        .modal-field select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .modal-field-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Syne', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .modal-btn.cancel:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .modal-btn.save {
            background: var(--accent-cyan);
            border: none;
            color: var(--bg-dark);
        }

        .modal-btn.save:hover {
            background: #00d4b8;
        }

        /* Investment View Styles */
        .investment-view {
            padding-top: 32px;
        }

        .investment-header {
            margin-bottom: 32px;
        }

        .investment-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .investment-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .investment-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .investment-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .investment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .investment-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .investment-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .investment-card label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .investment-card input,
        .investment-card select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            color: var(--text-primary);
        }

        .investment-card input:focus,
        .investment-card select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .currency-input {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0 16px;
        }

        .currency-input:focus-within {
            border-color: var(--accent-cyan);
        }

        .currency-symbol {
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
        }

        .currency-input input {
            background: transparent;
            border: none;
            padding: 12px 8px;
        }

        .currency-input input:focus {
            outline: none;
            border-color: transparent;
        }

        .percentage-display,
        .calculated-value {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        /* Use of Funds */
        .use-of-funds {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 32px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .use-of-funds {
                grid-template-columns: 1fr;
            }
        }

        .fund-allocation {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fund-row {
            display: grid;
            grid-template-columns: 1fr 80px 30px 100px;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .fund-row.total {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 8px;
        }

        .fund-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .fund-row input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            color: var(--text-primary);
            text-align: right;
        }

        .fund-row input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .fund-percent {
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
        }

        .fund-auto-percent {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        .fund-amount {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            color: var(--accent-cyan);
            text-align: right;
        }

        .fund-total-percent {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            grid-column: span 2;
            text-align: right;
            padding-right: 30px;
        }

        .fund-row.total .fund-label {
            font-weight: 600;
        }

        .fund-row.total .fund-amount {
            font-weight: 600;
            color: var(--accent-yellow);
        }

        .funds-chart {
            width: 200px;
            height: 200px;
        }

        /* Milestones */
        .milestones-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .milestone-item {
            display: grid;
            grid-template-columns: 100px 1fr auto;
            align-items: center;
            gap: 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .milestone-item select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
        }

        .milestone-item input {
            background: transparent;
            border: none;
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            flex: 1;
        }

        .milestone-item input:focus {
            outline: none;
        }

        .milestone-item input::placeholder {
            color: var(--text-muted);
        }

        .milestone-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .milestone-delete:hover {
            color: #ff6b6b;
        }

        .add-milestone-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-milestone-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* Business Plan Profitability Styles */
        .bp-profitability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .bp-profitability-grid {
                grid-template-columns: 1fr;
            }
        }

        .bp-profit-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }

        .bp-profit-card.y1 { border-left: 3px solid var(--accent-cyan); }
        .bp-profit-card.y2 { border-left: 3px solid var(--accent-magenta); }
        .bp-profit-card.y3 { border-left: 3px solid var(--accent-yellow); }

        .bp-profit-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }

        .bp-profit-row span:first-child {
            color: var(--text-secondary);
        }

        .bp-profit-row span:last-child {
            font-family: 'Space Mono', monospace;
        }

        .bp-profit-row.revenue span:last-child { color: var(--accent-cyan); }
        .bp-profit-row.costs span:last-child { color: var(--accent-magenta); }
        .bp-profit-row.profit span:last-child { color: var(--accent-yellow); }
        .bp-profit-row.profit.negative span:last-child { color: #ff6b6b; }

        .bp-grand-totals {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .bp-grand-total-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .bp-grand-total-card.revenue { border-color: rgba(0, 245, 212, 0.3); }
        .bp-grand-total-card.costs { border-color: rgba(247, 37, 133, 0.3); }
        .bp-grand-total-card.profit { border-color: rgba(254, 228, 64, 0.3); }

        .bp-grand-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .bp-grand-amount {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .bp-grand-total-card.revenue .bp-grand-amount { color: var(--accent-cyan); }
        .bp-grand-total-card.costs .bp-grand-amount { color: var(--accent-magenta); }
        .bp-grand-total-card.profit .bp-grand-amount { color: var(--accent-yellow); }

        .bp-margin-badge {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 12px;
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            background: rgba(254, 228, 64, 0.15);
            color: var(--accent-yellow);
        }

        .bp-margin-badge.negative {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }

        .bp-margin-badge.positive {
            background: rgba(0, 245, 212, 0.15);
            color: var(--accent-cyan);
        }

        .bp-profit-margin {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 12px;
            background: rgba(254, 228, 64, 0.1);
            color: var(--accent-yellow);
        }

        .bp-profit-margin.negative {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .bp-profit-margin.positive {
            background: rgba(0, 245, 212, 0.1);
            color: var(--accent-cyan);
        }

        .bp-profit-year {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        /* Business Plan Investment Section */
        .bp-investment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .bp-investment-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .bp-invest-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .bp-invest-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .bp-invest-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 4px;
        }

        .bp-invest-sublabel {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bp-milestones {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
        }

        .bp-milestones-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .bp-milestones-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bp-milestone-item {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bp-milestone-month {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--accent-cyan);
            background: rgba(0, 245, 212, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            min-width: 60px;
            text-align: center;
        }

        .bp-milestone-text {
            font-size: 14px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Saved
    </div>

    <!-- Reset Button (fixed position) -->
    <button class="reset-btn-fixed" onclick="clearSavedState()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
        </svg>
        Reset
    </button>

    <div class="container">
        <header>
            <div class="logo">Sonic Grid</div>
            <h1>Business Model</h1>
            <p class="subtitle">Model growth, revenue, costs, and investment across 3 years.</p>
            <div class="view-tabs">
                <button class="view-tab active" data-view="revenue">Revenue</button>
                <button class="view-tab" data-view="costs">Costs</button>
                <button class="view-tab" data-view="investment">Investment</button>
                <button class="view-tab" data-view="business-plan">Business Plan</button>
            </div>
        </header>

        <!-- Revenue View -->
        <div class="view-container active" id="revenueView">

        <!-- Growth Settings Panel -->
        <div class="growth-panel">
            <div class="panel-header">
                <h2 class="panel-title">Growth Projections</h2>
                <div class="curve-selector">
                    <button class="curve-btn active" data-curve="linear">Linear</button>
                    <button class="curve-btn" data-curve="scurve">S-Curve</button>
                    <button class="curve-btn" data-curve="exponential">Exponential</button>
                </div>
            </div>
            <div class="growth-grid">
                <div class="year-card year-1">
                    <div class="year-label">Year 1</div>
                    <div class="year-inputs">
                        <div class="input-group">
                            <label>Starting Artists</label>
                            <input type="text" id="y1StartArtists" value="0" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Artists</label>
                            <input type="text" id="y1EndArtists" value="20,000" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Starting Listeners</label>
                            <input type="text" id="y1StartListeners" value="0" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Listeners</label>
                            <input type="text" id="y1EndListeners" value="200,000" class="comma-input">
                        </div>
                    </div>
                </div>
                <div class="year-card year-2">
                    <div class="year-label">Year 2</div>
                    <div class="year-inputs">
                        <div class="input-group">
                            <label>Starting Artists</label>
                            <input type="text" id="y2StartArtists" value="20,000" readonly style="opacity: 0.6;" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Artists</label>
                            <input type="text" id="y2EndArtists" value="100,000" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Starting Listeners</label>
                            <input type="text" id="y2StartListeners" value="200,000" readonly style="opacity: 0.6;" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Listeners</label>
                            <input type="text" id="y2EndListeners" value="1,500,000" class="comma-input">
                        </div>
                    </div>
                </div>
                <div class="year-card year-3">
                    <div class="year-label">Year 3</div>
                    <div class="year-inputs">
                        <div class="input-group">
                            <label>Starting Artists</label>
                            <input type="text" id="y3StartArtists" value="100,000" readonly style="opacity: 0.6;" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Artists</label>
                            <input type="text" id="y3EndArtists" value="300,000" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Starting Listeners</label>
                            <input type="text" id="y3StartListeners" value="1,500,000" readonly style="opacity: 0.6;" class="comma-input">
                        </div>
                        <div class="input-group">
                            <label>Ending Listeners</label>
                            <input type="text" id="y3EndListeners" value="6,000,000" class="comma-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">Growth & Revenue Trajectory</h2>
                <div class="chart-controls">
                    <div class="chart-view-toggle">
                        <button class="chart-view-btn active" data-view="monthly">Monthly</button>
                        <button class="chart-view-btn" data-view="yearly">Yearly</button>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot artists"></div>
                            <span>Artists</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot listeners"></div>
                            <span>Listeners</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot revenue"></div>
                            <span id="revenueLabel">Monthly Revenue</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-area">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="revenue-streams" id="streamsList">
                <!-- Revenue streams will be rendered here -->
            </div>

            <div class="summary-panel">
                <div class="summary-card">
                    <div class="summary-title">Revenue Summary</div>
                    
                    <div class="year-tabs">
                        <button class="year-tab active" data-year="1">Year 1</button>
                        <button class="year-tab" data-year="2">Year 2</button>
                        <button class="year-tab" data-year="3">Year 3</button>
                    </div>

                    <div class="total-revenue">
                        <div class="total-label">Annual Revenue</div>
                        <div class="total-amount" id="totalRevenue">$0</div>
                        <div class="total-period" id="revenuePeriod">Year 1</div>
                    </div>

                    <div class="three-year-summary">
                        <div class="three-year-item">
                            <div class="three-year-label">Y1 Total</div>
                            <div class="three-year-value" id="y1Total">$0</div>
                        </div>
                        <div class="three-year-item">
                            <div class="three-year-label">Y2 Total</div>
                            <div class="three-year-value" id="y2Total">$0</div>
                        </div>
                        <div class="three-year-item">
                            <div class="three-year-label">Y3 Total</div>
                            <div class="three-year-value" id="y3Total">$0</div>
                        </div>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-box">
                            <div class="metric-label">Monthly (Avg)</div>
                            <div class="metric-value positive" id="monthlyRevenue">$0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Active Streams</div>
                            <div class="metric-value highlight" id="activeStreams">0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Per Artist (EOY)</div>
                            <div class="metric-value" id="revenuePerArtist">$0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Per Listener (EOY)</div>
                            <div class="metric-value" id="revenuePerListener">$0</div>
                        </div>
                    </div>

                    <div class="breakdown-list" id="revenueBreakdown">
                        <!-- Breakdown will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <button class="add-stream-btn" onclick="openModal()">
            <span>+</span> Add Custom Revenue Stream
        </button>

        <!-- Monthly Breakdown Table -->
        <div class="monthly-table-container">
            <div class="table-toggle">
                <h2 class="chart-title">Month-by-Month Projections</h2>
            </div>
            <table class="monthly-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Artists</th>
                        <th>Listeners</th>
                        <th>Monthly Rev</th>
                        <th>Cumulative Rev</th>
                    </tr>
                </thead>
                <tbody id="monthlyTableBody">
                    <!-- Table rows will be rendered here -->
                </tbody>
            </table>
        </div>

        </div><!-- End Revenue View -->

        <!-- Costs View -->
        <div class="view-container costs-view" id="costsView">

            <!-- Costs Header -->
            <div class="costs-header">
                <div class="costs-header-left">
                    <h2 class="costs-title">Cost Structure</h2>
                    <p class="costs-subtitle">Model your operating costs across infrastructure, payroll, and marketing</p>
                </div>
                <div class="costs-header-right">
                    <button class="action-btn add-cost" onclick="openCostModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Cost
                    </button>
                </div>
            </div>

            <!-- Costs Totals Summary -->
            <div class="costs-totals-summary">
                <div class="cost-total-card">
                    <div class="cost-total-label">Year 1 Total</div>
                    <div class="cost-total-amount" id="costTotalY1">$0</div>
                </div>
                <div class="cost-total-card">
                    <div class="cost-total-label">Year 2 Total</div>
                    <div class="cost-total-amount" id="costTotalY2">$0</div>
                </div>
                <div class="cost-total-card">
                    <div class="cost-total-label">Year 3 Total</div>
                    <div class="cost-total-amount" id="costTotalY3">$0</div>
                </div>
                <div class="cost-total-card grand">
                    <div class="cost-total-label">3-Year Total</div>
                    <div class="cost-total-amount" id="costTotalAll">$0</div>
                </div>
            </div>

            <!-- Infrastructure Costs -->
            <div class="cost-category" id="infrastructureCosts">
                <div class="cost-category-header">
                    <div class="cost-category-title">
                        <span class="cost-category-badge infrastructure">Infrastructure</span>
                        <span class="cost-category-name">Cloud & Platform Costs</span>
                    </div>
                    <div class="cost-category-totals">
                        <div class="cost-cat-year"><span class="cost-cat-label">Y1</span><span class="cost-cat-amount" id="infraTotalY1">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y2</span><span class="cost-cat-amount" id="infraTotalY2">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y3</span><span class="cost-cat-amount" id="infraTotalY3">$0</span></div>
                    </div>
                </div>
                <div class="cost-items-grid" id="infraCostItems">
                    <!-- Cost items rendered by JS -->
                </div>
            </div>

            <!-- Payroll Costs -->
            <div class="cost-category" id="payrollCosts">
                <div class="cost-category-header">
                    <div class="cost-category-title">
                        <span class="cost-category-badge payroll">Payroll</span>
                        <span class="cost-category-name">Team & Personnel</span>
                    </div>
                    <div class="cost-category-totals">
                        <div class="cost-cat-year"><span class="cost-cat-label">Y1</span><span class="cost-cat-amount" id="payrollTotalY1">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y2</span><span class="cost-cat-amount" id="payrollTotalY2">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y3</span><span class="cost-cat-amount" id="payrollTotalY3">$0</span></div>
                    </div>
                </div>
                <div class="cost-items-grid" id="payrollCostItems">
                    <!-- Cost items rendered by JS -->
                </div>
            </div>

            <!-- OpEx Costs -->
            <div class="cost-category" id="opexCosts">
                <div class="cost-category-header">
                    <div class="cost-category-title">
                        <span class="cost-category-badge opex">OpEx</span>
                        <span class="cost-category-name">Operational Expenses</span>
                    </div>
                    <div class="cost-category-totals">
                        <div class="cost-cat-year"><span class="cost-cat-label">Y1</span><span class="cost-cat-amount" id="opexTotalY1">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y2</span><span class="cost-cat-amount" id="opexTotalY2">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y3</span><span class="cost-cat-amount" id="opexTotalY3">$0</span></div>
                    </div>
                </div>
                <div class="cost-items-grid" id="opexCostItems">
                    <!-- Cost items rendered by JS -->
                </div>
            </div>

            <!-- Marketing Costs -->
            <div class="cost-category" id="marketingCosts">
                <div class="cost-category-header">
                    <div class="cost-category-title">
                        <span class="cost-category-badge marketing">Marketing</span>
                        <span class="cost-category-name">Customer Acquisition</span>
                    </div>
                    <div class="cost-category-totals">
                        <div class="cost-cat-year"><span class="cost-cat-label">Y1</span><span class="cost-cat-amount" id="marketingTotalY1">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y2</span><span class="cost-cat-amount" id="marketingTotalY2">$0</span></div>
                        <div class="cost-cat-year"><span class="cost-cat-label">Y3</span><span class="cost-cat-amount" id="marketingTotalY3">$0</span></div>
                    </div>
                </div>
                <div class="cost-items-grid" id="marketingCostItems">
                    <!-- Cost items rendered by JS -->
                </div>
            </div>

        </div><!-- End Costs View -->

        <!-- Investment View -->
        <div class="view-container investment-view" id="investmentView">

            <!-- Investment Header -->
            <div class="investment-header">
                <div class="investment-header-left">
                    <h2 class="investment-title">Investment Round</h2>
                    <p class="investment-subtitle">Define your fundraising parameters for the pitch deck</p>
                </div>
            </div>

            <!-- The Ask -->
            <div class="investment-section">
                <h3 class="investment-section-title">The Ask</h3>
                <div class="investment-grid">
                    <div class="investment-card">
                        <label>Raising Amount</label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="text" id="raisingAmount" value="3,000,000" class="comma-input" onchange="updateInvestment()">
                        </div>
                    </div>
                    <div class="investment-card">
                        <label>Round Type</label>
                        <select id="roundType" onchange="updateInvestment()">
                            <option value="Pre-Seed">Pre-Seed</option>
                            <option value="Seed" selected>Seed</option>
                            <option value="Series A">Series A</option>
                        </select>
                    </div>
                    <div class="investment-card">
                        <label>Pre-Money Valuation</label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="text" id="preMoneyValuation" value="12,000,000" class="comma-input" onchange="updateInvestment()">
                        </div>
                    </div>
                    <div class="investment-card">
                        <label>Equity Offered</label>
                        <div class="percentage-display" id="equityOffered">20.0%</div>
                    </div>
                </div>
            </div>

            <!-- Use of Funds -->
            <div class="investment-section">
                <h3 class="investment-section-title">Use of Funds <span style="font-size: 12px; font-weight: 400; color: var(--text-muted);">(auto-calculated from costs for runway period)</span></h3>
                <div class="use-of-funds">
                    <div class="fund-allocation">
                        <div class="fund-row">
                            <span class="fund-label">Infrastructure</span>
                            <span class="fund-auto-percent" id="fundInfraPercent">0%</span>
                            <span class="fund-amount" id="fundInfraAmt">$0</span>
                        </div>
                        <div class="fund-row">
                            <span class="fund-label">Payroll</span>
                            <span class="fund-auto-percent" id="fundPayrollPercent">0%</span>
                            <span class="fund-amount" id="fundPayrollAmt">$0</span>
                        </div>
                        <div class="fund-row">
                            <span class="fund-label">Marketing</span>
                            <span class="fund-auto-percent" id="fundMarketingPercent">0%</span>
                            <span class="fund-amount" id="fundMarketingAmt">$0</span>
                        </div>
                        <div class="fund-row">
                            <span class="fund-label">OpEx</span>
                            <span class="fund-auto-percent" id="fundOpexPercent">0%</span>
                            <span class="fund-amount" id="fundOpexAmt">$0</span>
                        </div>
                        <div class="fund-row">
                            <span class="fund-label">Reserve / Buffer</span>
                            <input type="number" id="fundReserve" value="10" min="0" max="100" onchange="updateFundsAllocation()">
                            <span class="fund-percent">%</span>
                            <span class="fund-amount" id="fundReserveAmt">$0</span>
                        </div>
                        <div class="fund-row total">
                            <span class="fund-label">Total</span>
                            <span class="fund-total-percent" id="fundTotalPercent">100%</span>
                            <span class="fund-amount" id="fundTotalAmt">$3.0M</span>
                        </div>
                    </div>
                    <div class="funds-chart">
                        <canvas id="fundsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Runway & Milestones -->
            <div class="investment-section">
                <h3 class="investment-section-title">Runway & Milestones</h3>
                <div class="investment-grid">
                    <div class="investment-card">
                        <label>Target Runway</label>
                        <select id="targetRunway" onchange="updateInvestment()">
                            <option value="12">12 months</option>
                            <option value="18" selected>18 months</option>
                            <option value="24">24 months</option>
                            <option value="36">36 months</option>
                        </select>
                    </div>
                    <div class="investment-card">
                        <label>Monthly Burn Rate</label>
                        <div class="calculated-value" id="monthlyBurnRate">$167K</div>
                    </div>
                    <div class="investment-card">
                        <label>Break-Even Target</label>
                        <select id="breakEvenTarget" onchange="updateInvestment()">
                            <option value="18">Month 18</option>
                            <option value="24" selected>Month 24</option>
                            <option value="30">Month 30</option>
                            <option value="36">Month 36</option>
                        </select>
                    </div>
                    <div class="investment-card">
                        <label>Next Round Target</label>
                        <select id="nextRoundTarget" onchange="updateInvestment()">
                            <option value="Series A" selected>Series A</option>
                            <option value="Series B">Series B</option>
                            <option value="Profitability">Profitability</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Key Milestones -->
            <div class="investment-section">
                <h3 class="investment-section-title">Key Milestones (This Round)</h3>
                <div class="milestones-list" id="milestonesList">
                    <!-- Rendered by JS -->
                </div>
                <button class="add-milestone-btn" onclick="addMilestone()">
                    <span>+</span> Add Milestone
                </button>
            </div>

            <!-- Traction & Metrics to Date -->
            <div class="investment-section">
                <h3 class="investment-section-title">Current Traction</h3>
                <div class="investment-grid">
                    <div class="investment-card">
                        <label>Current MRR</label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="text" id="currentMRR" value="0" class="comma-input" onchange="updateInvestment()">
                        </div>
                    </div>
                    <div class="investment-card">
                        <label>Current Users</label>
                        <input type="text" id="currentUsers" value="0" class="comma-input" onchange="updateInvestment()">
                    </div>
                    <div class="investment-card">
                        <label>Waitlist Size</label>
                        <input type="text" id="waitlistSize" value="0" class="comma-input" onchange="updateInvestment()">
                    </div>
                    <div class="investment-card">
                        <label>Product Stage</label>
                        <select id="productStage" onchange="updateInvestment()">
                            <option value="Concept">Concept</option>
                            <option value="Prototype">Prototype</option>
                            <option value="MVP" selected>MVP</option>
                            <option value="Beta">Beta</option>
                            <option value="Live">Live</option>
                        </select>
                    </div>
                </div>
            </div>

        </div><!-- End Investment View -->

        <!-- Cost Modal -->
        <div class="modal-overlay" id="costModalOverlay" onclick="closeCostModal()">
            <div class="cost-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Add New Cost</h3>
                    <button class="modal-close" onclick="closeCostModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-field">
                        <label>Cost Name</label>
                        <input type="text" id="costName" placeholder="e.g., Server Hosting">
                    </div>
                    <div class="modal-field">
                        <label>Category</label>
                        <select id="costCategory">
                            <option value="infrastructure">Infrastructure</option>
                            <option value="payroll">Payroll</option>
                            <option value="opex">OpEx</option>
                            <option value="marketing">Marketing</option>
                        </select>
                    </div>
                    <div class="modal-field-row">
                        <div class="modal-field">
                            <label>Year 1 Cost</label>
                            <input type="text" id="costY1" placeholder="0" class="comma-input">
                        </div>
                        <div class="modal-field">
                            <label>Year 2 Cost</label>
                            <input type="text" id="costY2" placeholder="0" class="comma-input">
                        </div>
                        <div class="modal-field">
                            <label>Year 3 Cost</label>
                            <input type="text" id="costY3" placeholder="0" class="comma-input">
                        </div>
                    </div>
                    <div class="modal-field">
                        <label>Notes (optional)</label>
                        <input type="text" id="costNotes" placeholder="Additional details...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeCostModal()">Cancel</button>
                    <button class="modal-btn save" onclick="saveCostItem()">Add Cost</button>
                </div>
            </div>
        </div>

        <!-- Business Plan View -->
        <div class="view-container business-plan-view" id="businessPlanView">

            <!-- Export Bar -->
            <div class="bp-export-bar">
                <button class="action-btn export" id="exportBtn" onclick="exportToPDF()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export PDF
                </button>
            </div>

            <!-- Executive Summary -->
            <div class="bp-section">
                <div class="bp-grand-totals">
                    <div class="bp-grand-total-card revenue">
                        <div class="bp-grand-label">3-Year Revenue</div>
                        <div class="bp-grand-amount" id="bpTotalRevenue">$0</div>
                    </div>
                    <div class="bp-grand-total-card costs">
                        <div class="bp-grand-label">3-Year Costs</div>
                        <div class="bp-grand-amount" id="bpTotalCosts">$0</div>
                    </div>
                    <div class="bp-grand-total-card profit">
                        <div class="bp-grand-label">3-Year Profit</div>
                        <div class="bp-grand-amount" id="bpTotalProfit">$0</div>
                        <div class="bp-margin-badge" id="bpTotalMargin">0%</div>
                    </div>
                </div>

                <!-- Profitability Grid -->
                <div class="bp-profitability-grid">
                    <div class="bp-profit-card y1">
                        <div class="bp-profit-year">Year 1</div>
                        <div class="bp-profit-row">
                            <span>Revenue</span>
                            <span id="bpY1Revenue">$0</span>
                        </div>
                        <div class="bp-profit-row">
                            <span>Costs</span>
                            <span id="bpY1Costs">$0</span>
                        </div>
                        <div class="bp-profit-row profit">
                            <span>Profit</span>
                            <span id="bpY1Profit">$0</span>
                        </div>
                        <div class="bp-profit-margin" id="bpY1Margin">0%</div>
                    </div>
                    <div class="bp-profit-card y2">
                        <div class="bp-profit-year">Year 2</div>
                        <div class="bp-profit-row">
                            <span>Revenue</span>
                            <span id="bpY2Revenue">$0</span>
                        </div>
                        <div class="bp-profit-row">
                            <span>Costs</span>
                            <span id="bpY2Costs">$0</span>
                        </div>
                        <div class="bp-profit-row profit">
                            <span>Profit</span>
                            <span id="bpY2Profit">$0</span>
                        </div>
                        <div class="bp-profit-margin" id="bpY2Margin">0%</div>
                    </div>
                    <div class="bp-profit-card y3">
                        <div class="bp-profit-year">Year 3</div>
                        <div class="bp-profit-row">
                            <span>Revenue</span>
                            <span id="bpY3Revenue">$0</span>
                        </div>
                        <div class="bp-profit-row">
                            <span>Costs</span>
                            <span id="bpY3Costs">$0</span>
                        </div>
                        <div class="bp-profit-row profit">
                            <span>Profit</span>
                            <span id="bpY3Profit">$0</span>
                        </div>
                        <div class="bp-profit-margin" id="bpY3Margin">0%</div>
                    </div>
                </div>

                <div class="bp-metric-grid" style="margin-top: 24px;">
                    <div class="bp-metric-box">
                        <div class="bp-metric-label">Active Revenue Streams</div>
                        <div class="bp-metric-value streams" id="bpActiveStreams">0</div>
                    </div>
                    <div class="bp-metric-box">
                        <div class="bp-metric-label">Active Cost Items</div>
                        <div class="bp-metric-value streams" id="bpActiveCosts">0</div>
                    </div>
                </div>

                <div class="bp-assumptions" id="bpAssumptions">
                    <!-- Rendered by JS -->
                </div>

                <div style="text-align: center;">
                    <div class="bp-curve-badge">
                        Growth Model: <span id="bpGrowthCurve">Linear</span>
                    </div>
                </div>
            </div>

            <!-- Revenue by Stream -->
            <div class="bp-section">
                <h3 class="bp-section-title">Revenue by Stream</h3>
                <table class="bp-table">
                    <thead>
                        <tr>
                            <th>Revenue Stream</th>
                            <th>Phase</th>
                            <th>Starts</th>
                            <th>Year 1</th>
                            <th>Year 2</th>
                            <th>Year 3</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="bpStreamTableBody">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Costs by Category -->
            <div class="bp-section">
                <h3 class="bp-section-title">Cost Breakdown</h3>
                <table class="bp-table">
                    <thead>
                        <tr>
                            <th>Cost Item</th>
                            <th>Category</th>
                            <th>Year 1</th>
                            <th>Year 2</th>
                            <th>Year 3</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="bpCostTableBody">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Investment Summary -->
            <div class="bp-section">
                <h3 class="bp-section-title">Investment Round</h3>
                <div class="bp-investment-grid">
                    <div class="bp-invest-card">
                        <div class="bp-invest-label">The Ask</div>
                        <div class="bp-invest-value" id="bpRaisingAmount">$3.0M</div>
                        <div class="bp-invest-sublabel" id="bpRoundType">Seed Round</div>
                    </div>
                    <div class="bp-invest-card">
                        <div class="bp-invest-label">Pre-Money Valuation</div>
                        <div class="bp-invest-value" id="bpValuation">$12.0M</div>
                        <div class="bp-invest-sublabel" id="bpEquity">20% equity</div>
                    </div>
                    <div class="bp-invest-card">
                        <div class="bp-invest-label">Target Runway</div>
                        <div class="bp-invest-value" id="bpRunway">18 months</div>
                        <div class="bp-invest-sublabel" id="bpBurnRate">$167K/mo burn</div>
                    </div>
                    <div class="bp-invest-card">
                        <div class="bp-invest-label">Next Milestone</div>
                        <div class="bp-invest-value" id="bpNextRound">Series A</div>
                        <div class="bp-invest-sublabel" id="bpBreakEven">Break-even M24</div>
                    </div>
                </div>

                <div class="bp-milestones">
                    <h4 class="bp-milestones-title">Key Milestones</h4>
                    <div class="bp-milestones-list" id="bpMilestonesList">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- Growth & Revenue Chart -->
            <div class="bp-section">
                <h3 class="bp-section-title">Growth & Revenue Trajectory</h3>
                <div class="chart-legend" style="margin-bottom: 16px;">
                    <div class="legend-item">
                        <div class="legend-dot artists"></div>
                        <span>Artists</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot listeners"></div>
                        <span>Listeners</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot revenue"></div>
                        <span>Monthly Revenue</span>
                    </div>
                </div>
                <div class="chart-area">
                    <canvas id="bpGrowthChart"></canvas>
                </div>
            </div>

        </div><!-- End Business Plan View -->

    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <button class="close-modal" onclick="closeModal()"></button>
            <h2 class="modal-title">Add Revenue Stream</h2>
            <div class="modal-inputs">
                <div class="input-group">
                    <label>Stream Name</label>
                    <input type="text" id="newStreamName" placeholder="e.g., Premium Subscriptions">
                </div>
                <div class="input-group">
                    <label>Revenue Type</label>
                    <select id="newStreamType">
                        <option value="recurring">Recurring (per month)</option>
                        <option value="transaction">Transaction-based</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Phase</label>
                    <select id="newStreamPhase">
                        <option value="MVP">MVP</option>
                        <option value="Phase 2">Phase 2</option>
                        <option value="Phase 3">Phase 3</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price Point ($)</label>
                    <input type="number" id="newStreamPrice" placeholder="9.99">
                </div>
                <div class="input-group">
                    <label>Adoption Y1 (%)</label>
                    <input type="number" id="newStreamAdoptionY1" placeholder="5" max="100">
                </div>
                <div class="input-group">
                    <label>Adoption Y2 (%)</label>
                    <input type="number" id="newStreamAdoptionY2" placeholder="10" max="100">
                </div>
                <div class="input-group">
                    <label>Adoption Y3 (%)</label>
                    <input type="number" id="newStreamAdoptionY3" placeholder="15" max="100">
                </div>
                <div class="input-group">
                    <label>Applies To</label>
                    <select id="newStreamTarget">
                        <option value="artists">Artists</option>
                        <option value="listeners">Listeners</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Starts</label>
                    <div class="start-time-group">
                        <select id="newStreamStartYear">
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                        </select>
                        <select id="newStreamStartMonth">
                            <option value="1">M1</option>
                            <option value="2">M2</option>
                            <option value="3">M3</option>
                            <option value="4">M4</option>
                            <option value="5">M5</option>
                            <option value="6">M6</option>
                            <option value="7">M7</option>
                            <option value="8">M8</option>
                            <option value="9">M9</option>
                            <option value="10">M10</option>
                            <option value="11">M11</option>
                            <option value="12">M12</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addStream()">Add Stream</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // State
        let selectedYear = 1;
        let growthCurve = 'linear';
        let chart = null;
        const STORAGE_KEY = 'sonicgrid_calculator_state';

        // Save state to LocalStorage
        function saveState() {
            const state = {
                selectedYear,
                growthCurve,
                revenueStreams,
                nextId,
                costItems,
                nextCostId,
                investmentData,
                growthInputs: {
                    y1StartArtists: document.getElementById('y1StartArtists').value,
                    y1EndArtists: document.getElementById('y1EndArtists').value,
                    y1StartListeners: document.getElementById('y1StartListeners').value,
                    y1EndListeners: document.getElementById('y1EndListeners').value,
                    y2EndArtists: document.getElementById('y2EndArtists').value,
                    y2EndListeners: document.getElementById('y2EndListeners').value,
                    y3EndArtists: document.getElementById('y3EndArtists').value,
                    y3EndListeners: document.getElementById('y3EndListeners').value
                },
                savedAt: new Date().toISOString()
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                showSaveIndicator();
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        // Load state from LocalStorage
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;

                const state = JSON.parse(saved);

                // Restore growth inputs
                if (state.growthInputs) {
                    document.getElementById('y1StartArtists').value = state.growthInputs.y1StartArtists;
                    document.getElementById('y1EndArtists').value = state.growthInputs.y1EndArtists;
                    document.getElementById('y1StartListeners').value = state.growthInputs.y1StartListeners;
                    document.getElementById('y1EndListeners').value = state.growthInputs.y1EndListeners;
                    document.getElementById('y2EndArtists').value = state.growthInputs.y2EndArtists;
                    document.getElementById('y2EndListeners').value = state.growthInputs.y2EndListeners;
                    document.getElementById('y3EndArtists').value = state.growthInputs.y3EndArtists;
                    document.getElementById('y3EndListeners').value = state.growthInputs.y3EndListeners;
                }

                // Restore other state
                if (state.selectedYear) selectedYear = state.selectedYear;
                if (state.growthCurve) growthCurve = state.growthCurve;
                if (state.revenueStreams) revenueStreams = state.revenueStreams;
                if (state.nextId) nextId = state.nextId;
                if (state.costItems) costItems = state.costItems;
                if (state.nextCostId) nextCostId = state.nextCostId;
                if (state.investmentData) investmentData = state.investmentData;

                // Update UI to reflect loaded state
                document.querySelectorAll('.curve-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.curve === growthCurve);
                });
                document.querySelectorAll('.year-tab').forEach(tab => {
                    tab.classList.toggle('active', parseInt(tab.dataset.year) === selectedYear);
                });

                return true;
            } catch (e) {
                console.error('Failed to load state:', e);
                return false;
            }
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 1500);
            }
        }

        // Clear saved state
        function clearSavedState() {
            if (confirm('Are you sure you want to reset to default settings? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // Export to PDF
        async function exportToPDF() {
            const exportBtn = document.getElementById('exportBtn');
            const exportBar = document.querySelector('.bp-export-bar');

            // Hide export bar during capture
            exportBar.style.display = 'none';
            exportBtn.classList.add('loading');

            try {
                const { jsPDF } = window.jspdf;

                // Always export the Business Plan view
                const businessPlanView = document.getElementById('businessPlanView');
                const wasHidden = !businessPlanView.classList.contains('active');

                // Temporarily show and render business plan view if not visible
                if (wasHidden) {
                    businessPlanView.style.display = 'block';
                    renderBusinessPlanView();
                }

                // Capture the business plan content
                const canvas = await html2canvas(businessPlanView, {
                    backgroundColor: '#0a0a0f',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: 1200,
                    windowWidth: 1200
                });

                // Hide again if it was hidden
                if (wasHidden) {
                    businessPlanView.style.display = '';
                }

                // Calculate PDF dimensions (A4 portrait for business plan)
                const imgWidth = 210; // A4 portrait width in mm
                const pageHeight = 297; // A4 portrait height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                const pdf = new jsPDF('p', 'mm', 'a4');

                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add additional pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Generate filename with date
                const date = new Date().toISOString().split('T')[0];
                pdf.save(`sonic-grid-business-plan-${date}.pdf`);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            } finally {
                // Restore export bar
                exportBar.style.display = '';
                exportBtn.classList.remove('loading');
            }
        }

        // Revenue streams
        let revenueStreams = [
            {
                id: 1,
                name: "Listener Subscription",
                phase: "MVP",
                type: "recurring",
                active: true,
                price: 9.99,
                adoptionY1: 5,
                adoptionY2: 8,
                adoptionY3: 12,
                target: "listeners",
                platformTake: 100,
                startYear: 1,
                startMonth: 1
            },
            {
                id: 2,
                name: "Artist Subscription",
                phase: "MVP",
                type: "recurring",
                active: true,
                price: 25,
                adoptionY1: 15,
                adoptionY2: 20,
                adoptionY3: 25,
                target: "artists",
                platformTake: 100,
                startYear: 1,
                startMonth: 1
            },
            {
                id: 3,
                name: "Fan-to-Artist Paywall",
                phase: "MVP",
                type: "transaction",
                active: true,
                price: 8,
                adoptionY1: 3,
                adoptionY2: 5,
                adoptionY3: 8,
                target: "listeners",
                platformTake: 15,
                frequency: 12,
                startYear: 1,
                startMonth: 1
            },
            {
                id: 5,
                name: "Podcast Subscriptions",
                phase: "Phase 2",
                type: "recurring",
                active: false,
                price: 7.99,
                adoptionY1: 2,
                adoptionY2: 3,
                adoptionY3: 5,
                target: "listeners",
                platformTake: 100,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 6,
                name: "Advertising/Sponsorship",
                phase: "Phase 3",
                type: "transaction",
                active: true,
                price: 0.06,
                adoptionY1: 80,
                adoptionY2: 85,
                adoptionY3: 90,
                target: "listeners",
                platformTake: 100,
                frequency: 100,
                startYear: 1,
                startMonth: 1
            },
            {
                id: 7,
                name: "Merchandise Platform",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 35,
                adoptionY1: 2,
                adoptionY2: 3,
                adoptionY3: 5,
                target: "listeners",
                platformTake: 12,
                frequency: 2,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 8,
                name: "Custom Features",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 50,
                adoptionY1: 10,
                adoptionY2: 15,
                adoptionY3: 20,
                target: "artists",
                platformTake: 100,
                frequency: 1,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 9,
                name: "Per-Track Sales",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 1.29,
                adoptionY1: 5,
                adoptionY2: 8,
                adoptionY3: 10,
                target: "listeners",
                platformTake: 30,
                frequency: 4,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 10,
                name: "App Store Commission",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 15,
                adoptionY1: 5,
                adoptionY2: 8,
                adoptionY3: 12,
                target: "artists",
                platformTake: 30,
                frequency: 12,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 11,
                name: "Design Templates",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 25,
                adoptionY1: 20,
                adoptionY2: 25,
                adoptionY3: 30,
                target: "artists",
                platformTake: 100,
                frequency: 2,
                startYear: 2,
                startMonth: 1
            },
            {
                id: 12,
                name: "Label Tier",
                phase: "Phase 3",
                type: "recurring",
                active: false,
                price: 199,
                adoptionY1: 2,
                adoptionY2: 3,
                adoptionY3: 5,
                target: "artists",
                platformTake: 100,
                startYear: 3,
                startMonth: 1
            },
            {
                id: 13,
                name: "Gig Marketplace",
                phase: "Phase 3",
                type: "transaction",
                active: false,
                price: 500,
                adoptionY1: 5,
                adoptionY2: 8,
                adoptionY3: 10,
                target: "artists",
                platformTake: 10,
                frequency: 4,
                startYear: 3,
                startMonth: 1
            },
            {
                id: 14,
                name: "Events & Ticketing",
                phase: "Phase 3",
                type: "transaction",
                active: false,
                price: 40,
                adoptionY1: 1,
                adoptionY2: 2,
                adoptionY3: 3,
                target: "listeners",
                platformTake: 8,
                frequency: 2,
                startYear: 3,
                startMonth: 1
            },
            {
                id: 15,
                name: "Gear Marketplace",
                phase: "Phase 2",
                type: "transaction",
                active: false,
                price: 250,
                adoptionY1: 8,
                adoptionY2: 10,
                adoptionY3: 12,
                target: "artists",
                platformTake: 10,
                frequency: 2,
                startYear: 2,
                startMonth: 1
            }
        ];

        // Helper to get absolute month from year/month
        function getAbsoluteMonth(year, month) {
            return (year - 1) * 12 + month;
        }

        let nextId = 16;

        // Cost items - categorized by type
        let costItems = [
            // Infrastructure Costs (annual amounts)
            { id: 1, name: "Storage (S3)", category: "infrastructure", active: true, y1: 9600, y2: 30000, y3: 90000, notes: "" },
            { id: 2, name: "CDN (CloudFront)", category: "infrastructure", active: true, y1: 42000, y2: 144000, y3: 420000, notes: "" },
            { id: 3, name: "Database (Supabase)", category: "infrastructure", active: true, y1: 4800, y2: 18000, y3: 60000, notes: "" },
            { id: 4, name: "Compute (Vercel)", category: "infrastructure", active: true, y1: 6000, y2: 24000, y3: 96000, notes: "" },
            { id: 5, name: "AI Generation", category: "infrastructure", active: true, y1: 144000, y2: 540000, y3: 1800000, notes: "" },
            { id: 6, name: "Email (Resend)", category: "infrastructure", active: true, y1: 2400, y2: 7200, y3: 24000, notes: "" },
            { id: 7, name: "Other Infrastructure", category: "infrastructure", active: true, y1: 3600, y2: 9600, y3: 30000, notes: "" },

            // Payroll Costs (annual amounts)
            { id: 8, name: "Engineering", category: "payroll", active: true, y1: 480000, y2: 960000, y3: 2400000, notes: "" },
            { id: 9, name: "Product & Design", category: "payroll", active: true, y1: 150000, y2: 300000, y3: 600000, notes: "" },
            { id: 10, name: "Marketing & Growth", category: "payroll", active: true, y1: 200000, y2: 600000, y3: 2000000, notes: "" },
            { id: 11, name: "Operations & Support", category: "payroll", active: true, y1: 100000, y2: 300000, y3: 800000, notes: "" },
            { id: 12, name: "Sales", category: "payroll", active: false, y1: 0, y2: 200000, y3: 600000, notes: "Starts Y2" },
            { id: 13, name: "G&A", category: "payroll", active: true, y1: 150000, y2: 400000, y3: 1000000, notes: "" },
            { id: 14, name: "Executive", category: "payroll", active: true, y1: 300000, y2: 500000, y3: 1000000, notes: "" },

            // OpEx Costs (annual amounts)
            { id: 15, name: "Office & Facilities", category: "opex", active: true, y1: 50000, y2: 150000, y3: 500000, notes: "" },
            { id: 16, name: "Software & Tools", category: "opex", active: true, y1: 30000, y2: 100000, y3: 300000, notes: "" },
            { id: 17, name: "Legal & Compliance", category: "opex", active: true, y1: 50000, y2: 150000, y3: 400000, notes: "" },
            { id: 18, name: "Insurance", category: "opex", active: true, y1: 20000, y2: 50000, y3: 150000, notes: "" },
            { id: 19, name: "Travel & Events", category: "opex", active: true, y1: 30000, y2: 100000, y3: 300000, notes: "" },
            { id: 20, name: "Professional Services", category: "opex", active: true, y1: 50000, y2: 150000, y3: 400000, notes: "" },
            { id: 21, name: "Contingency", category: "opex", active: true, y1: 23000, y2: 70000, y3: 205000, notes: "" },

            // Marketing/CAC Costs (annual amounts)
            { id: 22, name: "Paid Social", category: "marketing", active: true, y1: 100000, y2: 500000, y3: 2000000, notes: "" },
            { id: 23, name: "Content & SEO", category: "marketing", active: true, y1: 50000, y2: 200000, y3: 500000, notes: "" },
            { id: 24, name: "Influencer/Creator", category: "marketing", active: true, y1: 100000, y2: 400000, y3: 1500000, notes: "" },
            { id: 25, name: "PR & Brand", category: "marketing", active: true, y1: 50000, y2: 200000, y3: 500000, notes: "" },
            { id: 26, name: "Events & Sponsorships", category: "marketing", active: false, y1: 0, y2: 100000, y3: 500000, notes: "Starts Y2" },
            { id: 27, name: "Referral Programs", category: "marketing", active: true, y1: 50000, y2: 200000, y3: 1000000, notes: "" }
        ];

        let nextCostId = 28;

        // Growth curve functions
        function getGrowthValue(start, end, month, totalMonths, curve) {
            const t = month / totalMonths;
            
            switch(curve) {
                case 'linear':
                    return start + (end - start) * t;
                case 'scurve':
                    // S-curve using smoothstep
                    const s = t * t * (3 - 2 * t);
                    return start + (end - start) * s;
                case 'exponential':
                    // Exponential growth
                    if (start === 0) start = 1;
                    const ratio = end / start;
                    return start * Math.pow(ratio, t);
                default:
                    return start + (end - start) * t;
            }
        }

        function getMonthlyData() {
            const data = [];

            // Year 1
            const y1StartA = parseNumberInput(document.getElementById('y1StartArtists').value);
            const y1EndA = parseNumberInput(document.getElementById('y1EndArtists').value);
            const y1StartL = parseNumberInput(document.getElementById('y1StartListeners').value);
            const y1EndL = parseNumberInput(document.getElementById('y1EndListeners').value);

            // Year 2
            const y2EndA = parseNumberInput(document.getElementById('y2EndArtists').value);
            const y2EndL = parseNumberInput(document.getElementById('y2EndListeners').value);

            // Year 3
            const y3EndA = parseNumberInput(document.getElementById('y3EndArtists').value);
            const y3EndL = parseNumberInput(document.getElementById('y3EndListeners').value);

            // Generate 36 months of data
            for (let m = 1; m <= 36; m++) {
                let artists, listeners, year;
                
                if (m <= 12) {
                    year = 1;
                    artists = getGrowthValue(y1StartA, y1EndA, m, 12, growthCurve);
                    listeners = getGrowthValue(y1StartL, y1EndL, m, 12, growthCurve);
                } else if (m <= 24) {
                    year = 2;
                    artists = getGrowthValue(y1EndA, y2EndA, m - 12, 12, growthCurve);
                    listeners = getGrowthValue(y1EndL, y2EndL, m - 12, 12, growthCurve);
                } else {
                    year = 3;
                    artists = getGrowthValue(y2EndA, y3EndA, m - 24, 12, growthCurve);
                    listeners = getGrowthValue(y2EndL, y3EndL, m - 24, 12, growthCurve);
                }

                // Calculate monthly revenue for this month
                let monthlyRev = 0;
                revenueStreams.forEach(stream => {
                    if (!stream.active) return;

                    // Check if stream has started yet
                    const streamStartMonth = getAbsoluteMonth(stream.startYear || 1, stream.startMonth || 1);
                    if (m < streamStartMonth) return;

                    let baseUsers = stream.target === 'artists' ? artists :
                                    stream.target === 'listeners' ? listeners :
                                    artists + listeners;

                    // Get adoption rate for the current year
                    const adoption = year === 1 ? (stream.adoptionY1 ?? stream.adoption ?? 0) :
                                     year === 2 ? (stream.adoptionY2 ?? stream.adoption ?? 0) :
                                     (stream.adoptionY3 ?? stream.adoption ?? 0);

                    const adoptingUsers = baseUsers * (adoption / 100);
                    const platformRevenue = stream.price * (stream.platformTake / 100);

                    if (stream.type === 'recurring') {
                        monthlyRev += adoptingUsers * platformRevenue;
                    } else {
                        const monthlyFreq = (stream.frequency || 12) / 12;
                        monthlyRev += adoptingUsers * platformRevenue * monthlyFreq;
                    }
                });

                data.push({
                    month: m,
                    year,
                    label: `Y${year} M${m <= 12 ? m : m <= 24 ? m - 12 : m - 24}`,
                    artists: Math.round(artists),
                    listeners: Math.round(listeners),
                    monthlyRevenue: monthlyRev
                });
            }

            return data;
        }

        function formatCurrency(amount) {
            if (amount >= 1000000000) {
                return '$' + (amount / 1000000000).toFixed(2) + 'B';
            } else if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(2) + 'M';
            } else if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(1) + 'K';
            }
            return '$' + Math.round(amount).toLocaleString();
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toLocaleString();
        }

        // Format number with commas for input display
        function formatNumberWithCommas(num) {
            return Math.round(num).toLocaleString();
        }

        // Parse number from input (strip commas)
        function parseNumberInput(value) {
            return parseInt(value.replace(/,/g, '')) || 0;
        }

        // Setup comma formatting for a numeric input
        function setupCommaInput(input) {
            // Format on blur
            input.addEventListener('blur', function() {
                const val = parseNumberInput(this.value);
                this.value = formatNumberWithCommas(val);
            });
            // Clear formatting on focus for easier editing
            input.addEventListener('focus', function() {
                const val = parseNumberInput(this.value);
                this.value = val;
            });
            // Initial format
            const val = parseNumberInput(input.value);
            input.value = formatNumberWithCommas(val);
        }

        function calculateYearlyRevenue(yearNum) {
            const monthlyData = getMonthlyData();
            const yearData = monthlyData.filter(d => d.year === yearNum);
            return yearData.reduce((sum, d) => sum + d.monthlyRevenue, 0);
        }

        let chartViewMode = 'monthly';

        function getYearlyChartData() {
            const monthlyData = getMonthlyData();
            const yearlyData = [];

            for (let year = 1; year <= 3; year++) {
                const yearMonths = monthlyData.filter(d => d.year === year);
                const lastMonth = yearMonths[yearMonths.length - 1];
                const yearRevenue = yearMonths.reduce((sum, d) => sum + d.monthlyRevenue, 0);

                yearlyData.push({
                    label: `Year ${year}`,
                    artists: lastMonth ? lastMonth.artists : 0,
                    listeners: lastMonth ? lastMonth.listeners : 0,
                    revenue: yearRevenue
                });
            }

            return yearlyData;
        }

        function renderChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');

            let labels, artistsData, listenersData, revenueData, revenueLabel;

            if (chartViewMode === 'yearly') {
                const yearlyData = getYearlyChartData();
                labels = yearlyData.map(d => d.label);
                artistsData = yearlyData.map(d => d.artists);
                listenersData = yearlyData.map(d => d.listeners);
                revenueData = yearlyData.map(d => d.revenue);
                revenueLabel = 'Annual Revenue';
            } else {
                const monthlyData = getMonthlyData();
                labels = monthlyData.map(d => d.label);
                artistsData = monthlyData.map(d => d.artists);
                listenersData = monthlyData.map(d => d.listeners);
                revenueData = monthlyData.map(d => d.monthlyRevenue);
                revenueLabel = 'Monthly Revenue';
            }

            // Update legend label
            document.getElementById('revenueLabel').textContent = revenueLabel;

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: chartViewMode === 'yearly' ? 'bar' : 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Artists',
                            data: artistsData,
                            borderColor: '#00f5d4',
                            backgroundColor: chartViewMode === 'yearly' ? 'rgba(0, 245, 212, 0.7)' : 'rgba(0, 245, 212, 0.1)',
                            fill: chartViewMode !== 'yearly',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Listeners',
                            data: listenersData,
                            borderColor: '#f72585',
                            backgroundColor: chartViewMode === 'yearly' ? 'rgba(247, 37, 133, 0.7)' : 'rgba(247, 37, 133, 0.1)',
                            fill: chartViewMode !== 'yearly',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: revenueLabel,
                            data: revenueData,
                            borderColor: '#fee440',
                            backgroundColor: chartViewMode === 'yearly' ? 'rgba(254, 228, 64, 0.7)' : 'rgba(254, 228, 64, 0.1)',
                            fill: chartViewMode !== 'yearly',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#12121a',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            titleFont: { family: 'Space Mono' },
                            bodyFont: { family: 'Space Mono' },
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('Revenue')) {
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                    return context.dataset.label + ': ' + formatNumber(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: {
                                color: '#8b8b9e',
                                font: { family: 'Space Mono', size: 10 },
                                maxRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: {
                                color: '#8b8b9e',
                                font: { family: 'Space Mono', size: 10 },
                                callback: (v) => formatNumber(v)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#fee440',
                                font: { family: 'Space Mono', size: 10 },
                                callback: (v) => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }

        // Cost calculation functions
        function calculateCostsByYear(year) {
            return costItems
                .filter(c => c.active)
                .reduce((sum, c) => sum + (year === 1 ? c.y1 : year === 2 ? c.y2 : c.y3), 0);
        }

        function calculateCostsByCategory(category) {
            return costItems
                .filter(c => c.active && c.category === category)
                .reduce((sum, c) => sum + c.y1 + c.y2 + c.y3, 0);
        }

        function getCategoryTotal(category, year) {
            return costItems
                .filter(c => c.active && c.category === category)
                .reduce((sum, c) => sum + (year === 1 ? c.y1 : year === 2 ? c.y2 : c.y3), 0);
        }

        // Calculate costs for a category over a given number of months (for Use of Funds)
        function getCategoryCostsForRunway(category, months) {
            // Prorate annual costs: Y1 for months 1-12, Y2 for months 13-24, Y3 for months 25-36
            let total = 0;
            const items = costItems.filter(c => c.active && c.category === category);

            items.forEach(item => {
                // Months in Y1
                const y1Months = Math.min(12, months);
                total += (item.y1 / 12) * y1Months;

                // Months in Y2
                if (months > 12) {
                    const y2Months = Math.min(12, months - 12);
                    total += (item.y2 / 12) * y2Months;
                }

                // Months in Y3
                if (months > 24) {
                    const y3Months = Math.min(12, months - 24);
                    total += (item.y3 / 12) * y3Months;
                }
            });

            return total;
        }

        function getTotalCosts() {
            return costItems
                .filter(c => c.active)
                .reduce((sum, c) => sum + c.y1 + c.y2 + c.y3, 0);
        }

        // Render costs view
        function renderCostsView() {
            const categories = ['infrastructure', 'payroll', 'opex', 'marketing'];
            const categoryContainers = {
                'infrastructure': 'infraCostItems',
                'payroll': 'payrollCostItems',
                'opex': 'opexCostItems',
                'marketing': 'marketingCostItems'
            };
            const categoryTotalIds = {
                'infrastructure': 'infraTotal',
                'payroll': 'payrollTotal',
                'opex': 'opexTotal',
                'marketing': 'marketingTotal'
            };

            categories.forEach(category => {
                const container = document.getElementById(categoryContainers[category]);
                const items = costItems.filter(c => c.category === category);

                container.innerHTML = items.map(cost => `
                    <div class="cost-card ${cost.active ? '' : 'inactive'}" data-id="${cost.id}">
                        <div class="cost-card-header">
                            <label class="toggle">
                                <input type="checkbox" ${cost.active ? 'checked' : ''} onchange="toggleCost(${cost.id})">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="cost-name">${cost.name}</span>
                            <button class="cost-delete" onclick="deleteCost(${cost.id})" title="Delete cost">&times;</button>
                        </div>
                        <div class="cost-amounts">
                            <div class="cost-year-input">
                                <label>Y1</label>
                                <input type="text" value="${formatNumberWithCommas(cost.y1)}"
                                    onchange="updateCostAmount(${cost.id}, 'y1', this.value)"
                                    onfocus="this.value = ${cost.y1}"
                                    onblur="this.value = formatNumberWithCommas(${cost.y1})">
                            </div>
                            <div class="cost-year-input">
                                <label>Y2</label>
                                <input type="text" value="${formatNumberWithCommas(cost.y2)}"
                                    onchange="updateCostAmount(${cost.id}, 'y2', this.value)"
                                    onfocus="this.value = ${cost.y2}"
                                    onblur="this.value = formatNumberWithCommas(${cost.y2})">
                            </div>
                            <div class="cost-year-input">
                                <label>Y3</label>
                                <input type="text" value="${formatNumberWithCommas(cost.y3)}"
                                    onchange="updateCostAmount(${cost.id}, 'y3', this.value)"
                                    onfocus="this.value = ${cost.y3}"
                                    onblur="this.value = formatNumberWithCommas(${cost.y3})">
                            </div>
                        </div>
                        ${cost.notes ? `<div class="cost-notes">${cost.notes}</div>` : ''}
                    </div>
                `).join('');

                // Update category totals for Y1/Y2/Y3
                const baseId = categoryTotalIds[category];
                document.getElementById(baseId + 'Y1').textContent = formatCurrency(getCategoryTotal(category, 1));
                document.getElementById(baseId + 'Y2').textContent = formatCurrency(getCategoryTotal(category, 2));
                document.getElementById(baseId + 'Y3').textContent = formatCurrency(getCategoryTotal(category, 3));
            });

            // Update summary totals
            document.getElementById('costTotalY1').textContent = formatCurrency(calculateCostsByYear(1));
            document.getElementById('costTotalY2').textContent = formatCurrency(calculateCostsByYear(2));
            document.getElementById('costTotalY3').textContent = formatCurrency(calculateCostsByYear(3));
            document.getElementById('costTotalAll').textContent = formatCurrency(getTotalCosts());

            // Update Use of Funds when costs change
            if (typeof updateFundsAllocation === 'function') {
                updateFundsAllocation();
            }
        }

        function toggleCost(id) {
            const cost = costItems.find(c => c.id === id);
            if (cost) {
                cost.active = !cost.active;
                renderCostsView();
                saveState();
            }
        }

        function updateCostAmount(id, yearKey, value) {
            const cost = costItems.find(c => c.id === id);
            if (cost) {
                // Parse currency input (handle commas, $, etc.)
                const numValue = parseNumberInput(value.replace(/[$]/g, ''));
                cost[yearKey] = numValue;
                renderCostsView();
                saveState();
            }
        }

        function deleteCost(id) {
            if (confirm('Delete this cost item?')) {
                costItems = costItems.filter(c => c.id !== id);
                renderCostsView();
                saveState();
            }
        }

        // Cost modal functions
        function openCostModal() {
            document.getElementById('costModalOverlay').classList.add('active');
            document.getElementById('costName').value = '';
            document.getElementById('costCategory').value = 'infrastructure';
            document.getElementById('costY1').value = '';
            document.getElementById('costY2').value = '';
            document.getElementById('costY3').value = '';
            document.getElementById('costNotes').value = '';
        }

        function closeCostModal() {
            document.getElementById('costModalOverlay').classList.remove('active');
        }

        function saveCostItem() {
            const name = document.getElementById('costName').value.trim();
            if (!name) {
                alert('Please enter a cost name');
                return;
            }

            const newCost = {
                id: nextCostId++,
                name: name,
                category: document.getElementById('costCategory').value,
                active: true,
                y1: parseNumberInput(document.getElementById('costY1').value),
                y2: parseNumberInput(document.getElementById('costY2').value),
                y3: parseNumberInput(document.getElementById('costY3').value),
                notes: document.getElementById('costNotes').value.trim()
            };

            costItems.push(newCost);
            closeCostModal();
            renderCostsView();
            saveState();
        }

        // Investment data
        let investmentData = {
            raisingAmount: 3000000,
            roundType: 'Seed',
            preMoneyValuation: 12000000,
            targetRunway: 18,
            breakEvenTarget: 24,
            nextRoundTarget: 'Series A',
            currentMRR: 0,
            currentUsers: 0,
            waitlistSize: 0,
            productStage: 'MVP',
            fundAllocation: {
                infrastructure: 0,
                payroll: 0,
                marketing: 0,
                opex: 0,
                reserve: 10
            },
            milestones: [
                { month: 6, text: 'Launch MVP to market' },
                { month: 12, text: 'Reach 10K active users' },
                { month: 18, text: 'Achieve $50K MRR' }
            ]
        };

        let fundsChart = null;

        function renderInvestmentView() {
            updateFundsAllocation();
            renderMilestones();
            renderFundsChart();
        }

        function updateInvestment() {
            // Parse raising amount
            investmentData.raisingAmount = parseNumberInput(document.getElementById('raisingAmount').value);

            // Parse pre-money valuation
            investmentData.preMoneyValuation = parseNumberInput(document.getElementById('preMoneyValuation').value);

            // Calculate equity offered
            const postMoney = investmentData.preMoneyValuation + investmentData.raisingAmount;
            const equity = postMoney > 0 ? (investmentData.raisingAmount / postMoney * 100) : 0;
            document.getElementById('equityOffered').textContent = equity.toFixed(1) + '%';

            // Get other values
            investmentData.roundType = document.getElementById('roundType').value;
            investmentData.targetRunway = parseInt(document.getElementById('targetRunway').value);
            investmentData.breakEvenTarget = parseInt(document.getElementById('breakEvenTarget').value);
            investmentData.nextRoundTarget = document.getElementById('nextRoundTarget').value;

            // Calculate monthly burn
            const monthlyBurn = investmentData.raisingAmount / investmentData.targetRunway;
            document.getElementById('monthlyBurnRate').textContent = formatCurrency(monthlyBurn);

            // Traction
            investmentData.currentMRR = parseNumberInput(document.getElementById('currentMRR').value);
            investmentData.currentUsers = parseNumberInput(document.getElementById('currentUsers').value);
            investmentData.waitlistSize = parseNumberInput(document.getElementById('waitlistSize').value);
            investmentData.productStage = document.getElementById('productStage').value;

            updateFundsAllocation();
            saveState();
        }

        function updateFundsAllocation() {
            const runway = investmentData.targetRunway || 18;
            const raising = investmentData.raisingAmount;
            const reservePercent = parseInt(document.getElementById('fundReserve').value) || 0;

            // Calculate costs for runway period by category
            const infraCost = getCategoryCostsForRunway('infrastructure', runway);
            const payrollCost = getCategoryCostsForRunway('payroll', runway);
            const marketingCost = getCategoryCostsForRunway('marketing', runway);
            const opexCost = getCategoryCostsForRunway('opex', runway);

            // Total projected costs (excluding reserve)
            const totalCosts = infraCost + payrollCost + marketingCost + opexCost;

            // Reserve amount from raising
            const reserveAmount = raising * (reservePercent / 100);

            // Calculate percentages based on raising amount
            const infraPercent = raising > 0 ? (infraCost / raising * 100) : 0;
            const payrollPercent = raising > 0 ? (payrollCost / raising * 100) : 0;
            const marketingPercent = raising > 0 ? (marketingCost / raising * 100) : 0;
            const opexPercent = raising > 0 ? (opexCost / raising * 100) : 0;

            investmentData.fundAllocation = {
                infrastructure: infraPercent,
                payroll: payrollPercent,
                marketing: marketingPercent,
                opex: opexPercent,
                reserve: reservePercent
            };

            // Update display - percentages
            document.getElementById('fundInfraPercent').textContent = infraPercent.toFixed(1) + '%';
            document.getElementById('fundPayrollPercent').textContent = payrollPercent.toFixed(1) + '%';
            document.getElementById('fundMarketingPercent').textContent = marketingPercent.toFixed(1) + '%';
            document.getElementById('fundOpexPercent').textContent = opexPercent.toFixed(1) + '%';

            // Update display - amounts
            document.getElementById('fundInfraAmt').textContent = formatCurrency(infraCost);
            document.getElementById('fundPayrollAmt').textContent = formatCurrency(payrollCost);
            document.getElementById('fundMarketingAmt').textContent = formatCurrency(marketingCost);
            document.getElementById('fundOpexAmt').textContent = formatCurrency(opexCost);
            document.getElementById('fundReserveAmt').textContent = formatCurrency(reserveAmount);

            // Update total
            const totalPercent = infraPercent + payrollPercent + marketingPercent + opexPercent + reservePercent;
            const totalEl = document.getElementById('fundTotalPercent');
            totalEl.textContent = totalPercent.toFixed(1) + '%';

            // Color based on whether costs fit within raising amount
            if (totalCosts + reserveAmount <= raising) {
                totalEl.style.color = 'var(--accent-cyan)';
            } else {
                totalEl.style.color = '#ff6b6b'; // Over budget
            }

            document.getElementById('fundTotalAmt').textContent = formatCurrency(totalCosts + reserveAmount);

            renderFundsChart();
            saveState();
        }

        function renderFundsChart() {
            const ctx = document.getElementById('fundsChart');
            if (!ctx) return;

            if (fundsChart) {
                fundsChart.destroy();
            }

            const { infrastructure, payroll, marketing, opex, reserve } = investmentData.fundAllocation;

            fundsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Infrastructure', 'Payroll', 'Marketing', 'OpEx', 'Reserve'],
                    datasets: [{
                        data: [infrastructure, payroll, marketing, opex, reserve],
                        backgroundColor: [
                            'rgba(0, 245, 212, 0.8)',
                            'rgba(247, 37, 133, 0.8)',
                            'rgba(123, 44, 191, 0.8)',
                            'rgba(254, 228, 64, 0.8)',
                            'rgba(100, 100, 100, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function renderMilestones() {
            const container = document.getElementById('milestonesList');
            if (!container) return;

            container.innerHTML = investmentData.milestones.map((m, i) => `
                <div class="milestone-item">
                    <select onchange="updateMilestone(${i}, 'month', this.value)">
                        ${[3, 6, 9, 12, 15, 18, 24, 30, 36].map(mo =>
                            `<option value="${mo}" ${m.month === mo ? 'selected' : ''}>Month ${mo}</option>`
                        ).join('')}
                    </select>
                    <input type="text" value="${m.text}" placeholder="Milestone description..."
                        onchange="updateMilestone(${i}, 'text', this.value)">
                    <button class="milestone-delete" onclick="deleteMilestone(${i})">&times;</button>
                </div>
            `).join('');
        }

        function updateMilestone(index, field, value) {
            if (field === 'month') {
                investmentData.milestones[index].month = parseInt(value);
            } else {
                investmentData.milestones[index].text = value;
            }
            saveState();
        }

        function addMilestone() {
            investmentData.milestones.push({ month: 12, text: '' });
            renderMilestones();
            saveState();
        }

        function deleteMilestone(index) {
            investmentData.milestones.splice(index, 1);
            renderMilestones();
            saveState();
        }

        function renderStreams() {
            const container = document.getElementById('streamsList');
            container.innerHTML = '';

            const y1Rev = {}, y2Rev = {}, y3Rev = {};
            const monthlyData = getMonthlyData();

            // Calculate per-stream revenue by year
            revenueStreams.forEach(stream => {
                y1Rev[stream.id] = 0;
                y2Rev[stream.id] = 0;
                y3Rev[stream.id] = 0;

                if (!stream.active) return;

                const streamStartMonth = getAbsoluteMonth(stream.startYear || 1, stream.startMonth || 1);

                monthlyData.forEach(d => {
                    // Skip months before stream starts
                    if (d.month < streamStartMonth) return;

                    let baseUsers = stream.target === 'artists' ? d.artists :
                                    stream.target === 'listeners' ? d.listeners :
                                    d.artists + d.listeners;

                    // Get adoption rate for the current year
                    const adoption = d.year === 1 ? (stream.adoptionY1 ?? stream.adoption ?? 0) :
                                     d.year === 2 ? (stream.adoptionY2 ?? stream.adoption ?? 0) :
                                     (stream.adoptionY3 ?? stream.adoption ?? 0);

                    const adoptingUsers = baseUsers * (adoption / 100);
                    const platformRevenue = stream.price * (stream.platformTake / 100);

                    let monthlyRev;
                    if (stream.type === 'recurring') {
                        monthlyRev = adoptingUsers * platformRevenue;
                    } else {
                        const monthlyFreq = (stream.frequency || 12) / 12;
                        monthlyRev = adoptingUsers * platformRevenue * monthlyFreq;
                    }

                    if (d.year === 1) y1Rev[stream.id] += monthlyRev;
                    else if (d.year === 2) y2Rev[stream.id] += monthlyRev;
                    else y3Rev[stream.id] += monthlyRev;
                });
            });

            revenueStreams.forEach(stream => {
                const phaseClass = stream.phase === 'MVP' ? 'mvp' :
                                   stream.phase === 'Phase 2' ? 'phase2' : 'phase3';

                const startYear = stream.startYear || 1;
                const startMonth = stream.startMonth || 1;

                // Generate year options
                const yearOptions = [1, 2, 3].map(y =>
                    `<option value="${y}" ${startYear === y ? 'selected' : ''}>Y${y}</option>`
                ).join('');

                // Generate month options
                const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(m =>
                    `<option value="${m}" ${startMonth === m ? 'selected' : ''}>M${m}</option>`
                ).join('');

                const html = `
                    <div class="stream-card ${stream.active ? 'active' : ''}" data-id="${stream.id}">
                        <div class="stream-header">
                            <div class="stream-info">
                                <div class="stream-toggle ${stream.active ? 'active' : ''}"
                                     onclick="toggleStream(${stream.id})"></div>
                                <div>
                                    <div class="stream-name">${stream.name}<span class="stream-start-badge">Starts Y${startYear} M${startMonth}</span></div>
                                    <span class="stream-phase ${phaseClass}">${stream.phase}</span>
                                </div>
                            </div>
                            <div class="stream-revenues">
                                <div class="stream-revenue-item">
                                    <div class="stream-revenue-label">Y1</div>
                                    <div class="stream-revenue y1">${formatCurrency(y1Rev[stream.id])}</div>
                                </div>
                                <div class="stream-revenue-item">
                                    <div class="stream-revenue-label">Y2</div>
                                    <div class="stream-revenue y2">${formatCurrency(y2Rev[stream.id])}</div>
                                </div>
                                <div class="stream-revenue-item">
                                    <div class="stream-revenue-label">Y3</div>
                                    <div class="stream-revenue y3">${formatCurrency(y3Rev[stream.id])}</div>
                                </div>
                            </div>
                        </div>
                        <div class="stream-inputs">
                            <div class="input-group">
                                <label>Price ($)</label>
                                <input type="number" value="${stream.price}" step="0.01"
                                       onchange="updateStream(${stream.id}, 'price', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Adopt Y1 (%)</label>
                                <input type="number" value="${stream.adoptionY1 ?? stream.adoption ?? 0}" max="100"
                                       onchange="updateStream(${stream.id}, 'adoptionY1', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Adopt Y2 (%)</label>
                                <input type="number" value="${stream.adoptionY2 ?? stream.adoption ?? 0}" max="100"
                                       onchange="updateStream(${stream.id}, 'adoptionY2', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Adopt Y3 (%)</label>
                                <input type="number" value="${stream.adoptionY3 ?? stream.adoption ?? 0}" max="100"
                                       onchange="updateStream(${stream.id}, 'adoptionY3', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Platform %</label>
                                <input type="number" value="${stream.platformTake}" max="100"
                                       onchange="updateStream(${stream.id}, 'platformTake', this.value)">
                            </div>
                            ${stream.type !== 'recurring' ? `
                            <div class="input-group">
                                <label>Freq/yr</label>
                                <input type="number" value="${stream.frequency || 12}"
                                       onchange="updateStream(${stream.id}, 'frequency', this.value)">
                            </div>
                            ` : ''}
                            <div class="input-group">
                                <label>Starts</label>
                                <div class="start-time-group">
                                    <select onchange="updateStream(${stream.id}, 'startYear', this.value)">
                                        ${yearOptions}
                                    </select>
                                    <select onchange="updateStream(${stream.id}, 'startMonth', this.value)">
                                        ${monthOptions}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            updateSummary();
            renderMonthlyTable();
        }

        function toggleStream(id) {
            const stream = revenueStreams.find(s => s.id === id);
            if (stream) {
                stream.active = !stream.active;
                renderStreams();
                renderChart();
                saveState();
            }
        }

        function updateStream(id, field, value) {
            const stream = revenueStreams.find(s => s.id === id);
            if (stream) {
                stream[field] = parseFloat(value) || 0;
                renderStreams();
                renderChart();
                saveState();
            }
        }

        function updateSummary() {
            const y1Total = calculateYearlyRevenue(1);
            const y2Total = calculateYearlyRevenue(2);
            const y3Total = calculateYearlyRevenue(3);

            document.getElementById('y1Total').textContent = formatCurrency(y1Total);
            document.getElementById('y2Total').textContent = formatCurrency(y2Total);
            document.getElementById('y3Total').textContent = formatCurrency(y3Total);

            const yearTotals = { 1: y1Total, 2: y2Total, 3: y3Total };
            const currentYearTotal = yearTotals[selectedYear];

            document.getElementById('totalRevenue').textContent = formatCurrency(currentYearTotal);
            document.getElementById('revenuePeriod').textContent = `Year ${selectedYear}`;
            document.getElementById('monthlyRevenue').textContent = formatCurrency(currentYearTotal / 12);

            // Get end of year counts for selected year
            let endArtists, endListeners;
            if (selectedYear === 1) {
                endArtists = parseNumberInput(document.getElementById('y1EndArtists').value);
                endListeners = parseNumberInput(document.getElementById('y1EndListeners').value);
            } else if (selectedYear === 2) {
                endArtists = parseNumberInput(document.getElementById('y2EndArtists').value);
                endListeners = parseNumberInput(document.getElementById('y2EndListeners').value);
            } else {
                endArtists = parseNumberInput(document.getElementById('y3EndArtists').value);
                endListeners = parseNumberInput(document.getElementById('y3EndListeners').value);
            }

            document.getElementById('revenuePerArtist').textContent = endArtists > 0 ? 
                formatCurrency(currentYearTotal / endArtists) : '$0';
            document.getElementById('revenuePerListener').textContent = endListeners > 0 ? 
                formatCurrency(currentYearTotal / endListeners) : '$0';

            // Active streams
            document.getElementById('activeStreams').textContent = 
                revenueStreams.filter(s => s.active).length;

            // Breakdown for selected year
            const breakdown = [];
            const monthlyData = getMonthlyData();
            
            revenueStreams.forEach(stream => {
                if (!stream.active) return;
                
                let yearRev = 0;
                monthlyData.filter(d => d.year === selectedYear).forEach(d => {
                    let baseUsers = stream.target === 'artists' ? d.artists :
                                    stream.target === 'listeners' ? d.listeners :
                                    d.artists + d.listeners;

                    // Get adoption rate for the current year
                    const adoption = d.year === 1 ? (stream.adoptionY1 ?? stream.adoption ?? 0) :
                                     d.year === 2 ? (stream.adoptionY2 ?? stream.adoption ?? 0) :
                                     (stream.adoptionY3 ?? stream.adoption ?? 0);

                    const adoptingUsers = baseUsers * (adoption / 100);
                    const platformRevenue = stream.price * (stream.platformTake / 100);

                    if (stream.type === 'recurring') {
                        yearRev += adoptingUsers * platformRevenue;
                    } else {
                        const monthlyFreq = (stream.frequency || 12) / 12;
                        yearRev += adoptingUsers * platformRevenue * monthlyFreq;
                    }
                });

                if (yearRev > 0) {
                    breakdown.push({ name: stream.name, amount: yearRev });
                }
            });

            breakdown.sort((a, b) => b.amount - a.amount);

            const breakdownHtml = breakdown.slice(0, 6).map(item => `
                <div class="breakdown-item">
                    <span class="breakdown-name">${item.name}</span>
                    <span class="breakdown-amount">${formatCurrency(item.amount)}</span>
                </div>
            `).join('');
            document.getElementById('revenueBreakdown').innerHTML = breakdownHtml;
        }

        function renderMonthlyTable() {
            const monthlyData = getMonthlyData();
            let cumulative = 0;
            let html = '';

            monthlyData.forEach((d, i) => {
                cumulative += d.monthlyRevenue;
                
                // Add year header row
                if (d.month === 1 || d.month === 13 || d.month === 25) {
                    html += `
                        <tr class="year-row">
                            <td colspan="5">Year ${d.year}</td>
                        </tr>
                    `;
                }

                html += `
                    <tr>
                        <td>${d.label}</td>
                        <td>${formatNumber(d.artists)}</td>
                        <td>${formatNumber(d.listeners)}</td>
                        <td>${formatCurrency(d.monthlyRevenue)}</td>
                        <td>${formatCurrency(cumulative)}</td>
                    </tr>
                `;
            });

            document.getElementById('monthlyTableBody').innerHTML = html;
        }

        // View switching
        let currentView = 'revenue';

        function switchView(viewName) {
            currentView = viewName;

            // Update tab buttons
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === viewName);
            });

            // Update view containers
            document.querySelectorAll('.view-container').forEach(container => {
                container.classList.remove('active');
            });

            if (viewName === 'revenue') {
                document.getElementById('revenueView').classList.add('active');
            } else if (viewName === 'costs') {
                document.getElementById('costsView').classList.add('active');
                renderCostsView();
            } else if (viewName === 'investment') {
                document.getElementById('investmentView').classList.add('active');
                renderInvestmentView();
            } else {
                document.getElementById('businessPlanView').classList.add('active');
                renderBusinessPlanView();
            }
        }

        function renderBusinessPlanView() {
            // Revenue calculations
            const y1Rev = calculateYearlyRevenue(1);
            const y2Rev = calculateYearlyRevenue(2);
            const y3Rev = calculateYearlyRevenue(3);
            const totalRev = y1Rev + y2Rev + y3Rev;
            const activeStreams = revenueStreams.filter(s => s.active).length;

            // Cost calculations
            const y1Cost = calculateCostsByYear(1);
            const y2Cost = calculateCostsByYear(2);
            const y3Cost = calculateCostsByYear(3);
            const totalCost = y1Cost + y2Cost + y3Cost;
            const activeCosts = costItems.filter(c => c.active).length;

            // Profit calculations
            const y1Profit = y1Rev - y1Cost;
            const y2Profit = y2Rev - y2Cost;
            const y3Profit = y3Rev - y3Cost;
            const totalProfit = totalRev - totalCost;

            // Margin calculations
            const y1Margin = y1Rev > 0 ? (y1Profit / y1Rev * 100) : 0;
            const y2Margin = y2Rev > 0 ? (y2Profit / y2Rev * 100) : 0;
            const y3Margin = y3Rev > 0 ? (y3Profit / y3Rev * 100) : 0;
            const totalMargin = totalRev > 0 ? (totalProfit / totalRev * 100) : 0;

            // Update grand totals
            document.getElementById('bpTotalRevenue').textContent = formatCurrency(totalRev);
            document.getElementById('bpTotalCosts').textContent = formatCurrency(totalCost);
            document.getElementById('bpTotalProfit').textContent = formatCurrency(totalProfit);
            const totalMarginEl = document.getElementById('bpTotalMargin');
            totalMarginEl.textContent = totalMargin.toFixed(1) + '% margin';
            totalMarginEl.className = 'bp-margin-badge ' + (totalProfit >= 0 ? 'positive' : 'negative');

            // Update yearly profitability cards
            document.getElementById('bpY1Revenue').textContent = formatCurrency(y1Rev);
            document.getElementById('bpY1Costs').textContent = formatCurrency(y1Cost);
            document.getElementById('bpY1Profit').textContent = formatCurrency(y1Profit);
            const y1MarginEl = document.getElementById('bpY1Margin');
            y1MarginEl.textContent = y1Margin.toFixed(1) + '%';
            y1MarginEl.className = 'bp-profit-margin ' + (y1Profit >= 0 ? 'positive' : 'negative');

            document.getElementById('bpY2Revenue').textContent = formatCurrency(y2Rev);
            document.getElementById('bpY2Costs').textContent = formatCurrency(y2Cost);
            document.getElementById('bpY2Profit').textContent = formatCurrency(y2Profit);
            const y2MarginEl = document.getElementById('bpY2Margin');
            y2MarginEl.textContent = y2Margin.toFixed(1) + '%';
            y2MarginEl.className = 'bp-profit-margin ' + (y2Profit >= 0 ? 'positive' : 'negative');

            document.getElementById('bpY3Revenue').textContent = formatCurrency(y3Rev);
            document.getElementById('bpY3Costs').textContent = formatCurrency(y3Cost);
            document.getElementById('bpY3Profit').textContent = formatCurrency(y3Profit);
            const y3MarginEl = document.getElementById('bpY3Margin');
            y3MarginEl.textContent = y3Margin.toFixed(1) + '%';
            y3MarginEl.className = 'bp-profit-margin ' + (y3Profit >= 0 ? 'positive' : 'negative');

            // Update counts
            document.getElementById('bpActiveStreams').textContent = activeStreams;
            document.getElementById('bpActiveCosts').textContent = activeCosts;
            document.getElementById('bpGrowthCurve').textContent = growthCurve.charAt(0).toUpperCase() + growthCurve.slice(1);

            // Render growth assumptions
            const y1StartA = document.getElementById('y1StartArtists').value;
            const y1EndA = document.getElementById('y1EndArtists').value;
            const y1StartL = document.getElementById('y1StartListeners').value;
            const y1EndL = document.getElementById('y1EndListeners').value;
            const y2EndA = document.getElementById('y2EndArtists').value;
            const y2EndL = document.getElementById('y2EndListeners').value;
            const y3EndA = document.getElementById('y3EndArtists').value;
            const y3EndL = document.getElementById('y3EndListeners').value;

            document.getElementById('bpAssumptions').innerHTML = `
                <div class="bp-assumption-card y1">
                    <div class="bp-assumption-title">Year 1</div>
                    <div class="bp-assumption-row">
                        <span>Artists</span>
                        <span>${formatNumber(parseNumberInput(y1StartA))}  ${formatNumber(parseNumberInput(y1EndA))}</span>
                    </div>
                    <div class="bp-assumption-row">
                        <span>Listeners</span>
                        <span>${formatNumber(parseNumberInput(y1StartL))}  ${formatNumber(parseNumberInput(y1EndL))}</span>
                    </div>
                </div>
                <div class="bp-assumption-card y2">
                    <div class="bp-assumption-title">Year 2</div>
                    <div class="bp-assumption-row">
                        <span>Artists</span>
                        <span>${formatNumber(parseNumberInput(y1EndA))}  ${formatNumber(parseNumberInput(y2EndA))}</span>
                    </div>
                    <div class="bp-assumption-row">
                        <span>Listeners</span>
                        <span>${formatNumber(parseNumberInput(y1EndL))}  ${formatNumber(parseNumberInput(y2EndL))}</span>
                    </div>
                </div>
                <div class="bp-assumption-card y3">
                    <div class="bp-assumption-title">Year 3</div>
                    <div class="bp-assumption-row">
                        <span>Artists</span>
                        <span>${formatNumber(parseNumberInput(y2EndA))}  ${formatNumber(parseNumberInput(y3EndA))}</span>
                    </div>
                    <div class="bp-assumption-row">
                        <span>Listeners</span>
                        <span>${formatNumber(parseNumberInput(y2EndL))}  ${formatNumber(parseNumberInput(y3EndL))}</span>
                    </div>
                </div>
            `;

            // Render revenue by stream table
            renderBPStreamTable();

            // Render costs table
            renderBPCostTable();

            // Render investment summary
            renderBPInvestment();

            // Render growth chart
            renderBPChart();
        }

        function renderBPInvestment() {
            // The Ask
            document.getElementById('bpRaisingAmount').textContent = formatCurrency(investmentData.raisingAmount);
            document.getElementById('bpRoundType').textContent = investmentData.roundType + ' Round';

            // Valuation
            document.getElementById('bpValuation').textContent = formatCurrency(investmentData.preMoneyValuation);
            const postMoney = investmentData.preMoneyValuation + investmentData.raisingAmount;
            const equity = postMoney > 0 ? (investmentData.raisingAmount / postMoney * 100) : 0;
            document.getElementById('bpEquity').textContent = equity.toFixed(1) + '% equity';

            // Runway
            document.getElementById('bpRunway').textContent = investmentData.targetRunway + ' months';
            const monthlyBurn = investmentData.raisingAmount / investmentData.targetRunway;
            document.getElementById('bpBurnRate').textContent = formatCurrency(monthlyBurn) + '/mo burn';

            // Next milestone
            document.getElementById('bpNextRound').textContent = investmentData.nextRoundTarget;
            document.getElementById('bpBreakEven').textContent = 'Break-even M' + investmentData.breakEvenTarget;

            // Milestones list
            const sortedMilestones = [...investmentData.milestones].sort((a, b) => a.month - b.month);
            document.getElementById('bpMilestonesList').innerHTML = sortedMilestones
                .filter(m => m.text)
                .map(m => `
                    <div class="bp-milestone-item">
                        <span class="bp-milestone-month">M${m.month}</span>
                        <span class="bp-milestone-text">${m.text}</span>
                    </div>
                `).join('');
        }

        function renderBPStreamTable() {
            const monthlyData = getMonthlyData();
            const streamData = [];

            revenueStreams.forEach(stream => {
                if (!stream.active) return;

                let y1Rev = 0, y2Rev = 0, y3Rev = 0;
                const streamStartMonth = getAbsoluteMonth(stream.startYear || 1, stream.startMonth || 1);

                monthlyData.forEach(d => {
                    // Skip months before stream starts
                    if (d.month < streamStartMonth) return;

                    let baseUsers = stream.target === 'artists' ? d.artists :
                                    stream.target === 'listeners' ? d.listeners :
                                    d.artists + d.listeners;

                    // Get adoption rate for the current year
                    const adoption = d.year === 1 ? (stream.adoptionY1 ?? stream.adoption ?? 0) :
                                     d.year === 2 ? (stream.adoptionY2 ?? stream.adoption ?? 0) :
                                     (stream.adoptionY3 ?? stream.adoption ?? 0);

                    const adoptingUsers = baseUsers * (adoption / 100);
                    const platformRevenue = stream.price * (stream.platformTake / 100);

                    let monthlyRev;
                    if (stream.type === 'recurring') {
                        monthlyRev = adoptingUsers * platformRevenue;
                    } else {
                        const monthlyFreq = (stream.frequency || 12) / 12;
                        monthlyRev = adoptingUsers * platformRevenue * monthlyFreq;
                    }

                    if (d.year === 1) y1Rev += monthlyRev;
                    else if (d.year === 2) y2Rev += monthlyRev;
                    else y3Rev += monthlyRev;
                });

                streamData.push({
                    name: stream.name,
                    phase: stream.phase,
                    startYear: stream.startYear || 1,
                    startMonth: stream.startMonth || 1,
                    y1: y1Rev,
                    y2: y2Rev,
                    y3: y3Rev,
                    total: y1Rev + y2Rev + y3Rev
                });
            });

            // Sort by phase first, then by start time within phase
            const phaseOrder = { 'MVP': 1, 'Phase 2': 2, 'Phase 3': 3 };
            streamData.sort((a, b) => {
                // First sort by phase
                if (phaseOrder[a.phase] !== phaseOrder[b.phase]) {
                    return phaseOrder[a.phase] - phaseOrder[b.phase];
                }
                // Within same phase, sort by start time
                const aStart = getAbsoluteMonth(a.startYear, a.startMonth);
                const bStart = getAbsoluteMonth(b.startYear, b.startMonth);
                if (aStart !== bStart) return aStart - bStart;
                // Within same start, sort by revenue
                return b.total - a.total;
            });

            let html = '';
            let totalY1 = 0, totalY2 = 0, totalY3 = 0, totalAll = 0;

            streamData.forEach(s => {
                const phaseClass = s.phase === 'MVP' ? 'mvp' :
                                   s.phase === 'Phase 2' ? 'phase2' : 'phase3';
                html += `
                    <tr>
                        <td>${s.name}</td>
                        <td><span class="phase-badge ${phaseClass}">${s.phase}</span></td>
                        <td>Y${s.startYear} M${s.startMonth}</td>
                        <td class="y1-value">${formatCurrency(s.y1)}</td>
                        <td class="y2-value">${formatCurrency(s.y2)}</td>
                        <td class="y3-value">${formatCurrency(s.y3)}</td>
                        <td>${formatCurrency(s.total)}</td>
                    </tr>
                `;
                totalY1 += s.y1;
                totalY2 += s.y2;
                totalY3 += s.y3;
                totalAll += s.total;
            });

            html += `
                <tr class="total-row">
                    <td colspan="3"><strong>Total</strong></td>
                    <td class="y1-value">${formatCurrency(totalY1)}</td>
                    <td class="y2-value">${formatCurrency(totalY2)}</td>
                    <td class="y3-value">${formatCurrency(totalY3)}</td>
                    <td>${formatCurrency(totalAll)}</td>
                </tr>
            `;

            document.getElementById('bpStreamTableBody').innerHTML = html;
        }

        function renderBPCostTable() {
            const categoryOrder = { 'infrastructure': 1, 'payroll': 2, 'opex': 3, 'marketing': 4 };
            const categoryLabels = {
                'infrastructure': 'Infrastructure',
                'payroll': 'Payroll',
                'opex': 'OpEx',
                'marketing': 'Marketing'
            };

            // Sort by category
            const sortedCosts = [...costItems]
                .filter(c => c.active)
                .sort((a, b) => categoryOrder[a.category] - categoryOrder[b.category]);

            let html = '';
            let totalY1 = 0, totalY2 = 0, totalY3 = 0, totalAll = 0;

            sortedCosts.forEach(c => {
                const total = c.y1 + c.y2 + c.y3;
                const categoryClass = c.category;
                html += `
                    <tr>
                        <td>${c.name}</td>
                        <td><span class="cost-category-badge ${categoryClass}">${categoryLabels[c.category]}</span></td>
                        <td class="y1-value">${formatCurrency(c.y1)}</td>
                        <td class="y2-value">${formatCurrency(c.y2)}</td>
                        <td class="y3-value">${formatCurrency(c.y3)}</td>
                        <td>${formatCurrency(total)}</td>
                    </tr>
                `;
                totalY1 += c.y1;
                totalY2 += c.y2;
                totalY3 += c.y3;
                totalAll += total;
            });

            html += `
                <tr class="total-row">
                    <td colspan="2"><strong>Total Costs</strong></td>
                    <td class="y1-value">${formatCurrency(totalY1)}</td>
                    <td class="y2-value">${formatCurrency(totalY2)}</td>
                    <td class="y3-value">${formatCurrency(totalY3)}</td>
                    <td>${formatCurrency(totalAll)}</td>
                </tr>
            `;

            document.getElementById('bpCostTableBody').innerHTML = html;
        }

        let bpChart = null;

        function renderBPChart() {
            const ctx = document.getElementById('bpGrowthChart').getContext('2d');
            const monthlyData = getMonthlyData();

            const labels = monthlyData.map(d => d.label);
            const artistsData = monthlyData.map(d => d.artists);
            const listenersData = monthlyData.map(d => d.listeners);
            const revenueData = monthlyData.map(d => d.monthlyRevenue);

            if (bpChart) {
                bpChart.destroy();
            }

            bpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Artists',
                            data: artistsData,
                            borderColor: '#00f5d4',
                            backgroundColor: 'rgba(0, 245, 212, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Listeners',
                            data: listenersData,
                            borderColor: '#f72585',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Monthly Revenue',
                            data: revenueData,
                            borderColor: '#fee440',
                            backgroundColor: 'rgba(254, 228, 64, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#12121a',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            titleFont: { family: 'Space Mono' },
                            bodyFont: { family: 'Space Mono' },
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Monthly Revenue') {
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                    return context.dataset.label + ': ' + formatNumber(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: {
                                color: '#8b8b9e',
                                font: { family: 'Space Mono', size: 10 },
                                maxRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: {
                                color: '#8b8b9e',
                                font: { family: 'Space Mono', size: 10 },
                                callback: (v) => formatNumber(v)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#fee440',
                                font: { family: 'Space Mono', size: 10 },
                                callback: (v) => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }

        function syncYearStarts() {
            // Y2 start = Y1 end
            document.getElementById('y2StartArtists').value = 
                document.getElementById('y1EndArtists').value;
            document.getElementById('y2StartListeners').value = 
                document.getElementById('y1EndListeners').value;
            
            // Y3 start = Y2 end
            document.getElementById('y3StartArtists').value = 
                document.getElementById('y2EndArtists').value;
            document.getElementById('y3StartListeners').value = 
                document.getElementById('y2EndListeners').value;
        }

        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function addStream() {
            const name = document.getElementById('newStreamName').value;
            const type = document.getElementById('newStreamType').value;
            const phase = document.getElementById('newStreamPhase').value;
            const price = parseFloat(document.getElementById('newStreamPrice').value) || 0;
            const adoptionY1 = parseFloat(document.getElementById('newStreamAdoptionY1').value) || 0;
            const adoptionY2 = parseFloat(document.getElementById('newStreamAdoptionY2').value) || 0;
            const adoptionY3 = parseFloat(document.getElementById('newStreamAdoptionY3').value) || 0;
            const target = document.getElementById('newStreamTarget').value;
            const startYear = parseInt(document.getElementById('newStreamStartYear').value) || 1;
            const startMonth = parseInt(document.getElementById('newStreamStartMonth').value) || 1;

            if (!name) {
                alert('Please enter a stream name');
                return;
            }

            const newStream = {
                id: nextId++,
                name,
                phase,
                type,
                active: true,
                price,
                adoptionY1,
                adoptionY2,
                adoptionY3,
                target,
                platformTake: 100,
                frequency: type === 'recurring' ? undefined : 12,
                startYear,
                startMonth
            };

            revenueStreams.push(newStream);
            closeModal();
            renderStreams();
            renderChart();
            saveState();

            // Clear form
            document.getElementById('newStreamName').value = '';
            document.getElementById('newStreamPrice').value = '';
            document.getElementById('newStreamAdoptionY1').value = '';
            document.getElementById('newStreamAdoptionY2').value = '';
            document.getElementById('newStreamAdoptionY3').value = '';
            document.getElementById('newStreamStartYear').value = '1';
            document.getElementById('newStreamStartMonth').value = '1';
        }

        // Event Listeners
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchView(tab.dataset.view);
            });
        });

        // Chart view toggle (monthly/yearly)
        document.querySelectorAll('.chart-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chart-view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                chartViewMode = btn.dataset.view;
                renderChart();
            });
        });

        document.querySelectorAll('.curve-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.curve-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                growthCurve = btn.dataset.curve;
                renderStreams();
                renderChart();
                saveState();
            });
        });

        document.querySelectorAll('.year-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.year-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                selectedYear = parseInt(tab.dataset.year);
                updateSummary();
                saveState();
            });
        });

        // Growth inputs
        document.querySelectorAll('.year-card input').forEach(input => {
            input.addEventListener('input', () => {
                syncYearStarts();
                renderStreams();
                renderChart();
                saveState();
            });
        });

        // Modal close on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        });

        // Initialize
        loadState(); // Load saved state first
        syncYearStarts();

        // Setup comma formatting for all numeric inputs
        document.querySelectorAll('.comma-input').forEach(input => {
            setupCommaInput(input);
        });

        renderStreams();
        renderChart();
    </script>
</body>
</html>
